Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _atom = require('atom');

var _sbEventKit = require('sb-event-kit');

var _helpers = require('../helpers');

let PanelDelegate = class PanelDelegate {

  constructor(panel) {
    this.panel = panel;
    this.emitter = new _sbEventKit.Emitter();
    this.messages = [];
    this.subscriptions = new _sbEventKit.CompositeDisposable();

    this.subscriptions.add(atom.config.observe('linter-ui-default.panelRepresents', panelRepresents => {
      const notInitial = typeof this.panelRepresents !== 'undefined';
      this.panelRepresents = panelRepresents;
      if (notInitial) {
        this.update();
      }
    }));
    this.subscriptions.add(atom.config.observe('linter-ui-default.panelHeight', panelHeight => {
      const notInitial = typeof this.panelHeight !== 'undefined';
      this.panelHeight = panelHeight;
      if (notInitial) {
        this.emitter.emit('observe-panel-config');
      }
    }));
    this.subscriptions.add(atom.config.observe('linter-ui-default.panelTakesMinimumHeight', panelTakesMinimumHeight => {
      const notInitial = typeof this.panelTakesMinimumHeight !== 'undefined';
      this.panelTakesMinimumHeight = panelTakesMinimumHeight;
      if (notInitial) {
        this.emitter.emit('observe-panel-config');
      }
    }));

    let changeSubscription;
    this.subscriptions.add(atom.workspace.observeActivePaneItem(paneItem => {
      if (changeSubscription) {
        changeSubscription.dispose();
        changeSubscription = null;
      }
      this.visibility = atom.workspace.isTextEditor(paneItem);
      this.emitter.emit('observe-visibility', this.visibility);
      if (this.visibility) {
        if (this.panelRepresents !== 'Entire Project') {
          this.update();
        }
        let oldRow = -1;
        changeSubscription = paneItem.onDidChangeCursorPosition(({ newBufferPosition }) => {
          if (oldRow !== newBufferPosition.row && this.panelRepresents === 'Current Line') {
            oldRow = newBufferPosition.row;
            this.update();
          }
        });
      }
      const shouldUpdate = typeof this.visibility !== 'undefined' && this.panelRepresents !== 'Entire Project';

      if (this.visibility && shouldUpdate) {
        this.update();
      }
    }));
    this.subscriptions.add(function () {
      if (changeSubscription) {
        changeSubscription.dispose();
      }
    });
  }
  get filteredMessages() {
    let filteredMessages = [];
    if (this.panelRepresents === 'Entire Project') {
      filteredMessages = this.messages;
    } else if (this.panelRepresents === 'Current File') {
      const activeEditor = atom.workspace.getActiveTextEditor();
      if (!activeEditor) return [];
      filteredMessages = (0, _helpers.filterMessages)(this.messages, activeEditor.getPath());
    } else if (this.panelRepresents === 'Current Line') {
      const activeEditor = atom.workspace.getActiveTextEditor();
      if (!activeEditor) return [];
      const activeLine = activeEditor.getCursors()[0].getBufferRow();
      filteredMessages = (0, _helpers.filterMessagesByRangeOrPoint)(this.messages, activeEditor.getPath(), _atom.Range.fromObject([[activeLine, 0], [activeLine, Infinity]]));
    }
    return filteredMessages;
  }
  update(messages = null) {
    if (Array.isArray(messages)) {
      this.messages = messages;
    }
    this.emitter.emit('observe-messages', this.filteredMessages);
  }
  updatePanelHeight(panelHeight) {
    atom.config.set('linter-ui-default.panelHeight', panelHeight);
  }
  onDidChangeMessages(callback) {
    return this.emitter.on('observe-messages', callback);
  }
  onDidChangeVisibility(callback) {
    return this.emitter.on('observe-visibility', callback);
  }
  onDidChangePanelConfig(callback) {
    return this.emitter.on('observe-panel-config', callback);
  }
  setPanelVisibility(visibility) {
    if (visibility && !this.panel.isVisible()) {
      this.panel.show();
    } else if (!visibility && this.panel.isVisible()) {
      this.panel.hide();
    }
  }
  dispose() {
    this.subscriptions.dispose();
  }
};
exports.default = PanelDelegate;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImRlbGVnYXRlLmpzIl0sIm5hbWVzIjpbIlBhbmVsRGVsZWdhdGUiLCJjb25zdHJ1Y3RvciIsInBhbmVsIiwiZW1pdHRlciIsIm1lc3NhZ2VzIiwic3Vic2NyaXB0aW9ucyIsImFkZCIsImF0b20iLCJjb25maWciLCJvYnNlcnZlIiwicGFuZWxSZXByZXNlbnRzIiwibm90SW5pdGlhbCIsInVwZGF0ZSIsInBhbmVsSGVpZ2h0IiwiZW1pdCIsInBhbmVsVGFrZXNNaW5pbXVtSGVpZ2h0IiwiY2hhbmdlU3Vic2NyaXB0aW9uIiwid29ya3NwYWNlIiwib2JzZXJ2ZUFjdGl2ZVBhbmVJdGVtIiwicGFuZUl0ZW0iLCJkaXNwb3NlIiwidmlzaWJpbGl0eSIsImlzVGV4dEVkaXRvciIsIm9sZFJvdyIsIm9uRGlkQ2hhbmdlQ3Vyc29yUG9zaXRpb24iLCJuZXdCdWZmZXJQb3NpdGlvbiIsInJvdyIsInNob3VsZFVwZGF0ZSIsImZpbHRlcmVkTWVzc2FnZXMiLCJhY3RpdmVFZGl0b3IiLCJnZXRBY3RpdmVUZXh0RWRpdG9yIiwiZ2V0UGF0aCIsImFjdGl2ZUxpbmUiLCJnZXRDdXJzb3JzIiwiZ2V0QnVmZmVyUm93IiwiZnJvbU9iamVjdCIsIkluZmluaXR5IiwiQXJyYXkiLCJpc0FycmF5IiwidXBkYXRlUGFuZWxIZWlnaHQiLCJzZXQiLCJvbkRpZENoYW5nZU1lc3NhZ2VzIiwiY2FsbGJhY2siLCJvbiIsIm9uRGlkQ2hhbmdlVmlzaWJpbGl0eSIsIm9uRGlkQ2hhbmdlUGFuZWxDb25maWciLCJzZXRQYW5lbFZpc2liaWxpdHkiLCJpc1Zpc2libGUiLCJzaG93IiwiaGlkZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFFQTs7QUFDQTs7QUFJQTs7SUFHcUJBLGEsR0FBTixNQUFNQSxhQUFOLENBQW9COztBQVVqQ0MsY0FBWUMsS0FBWixFQUEwQjtBQUN4QixTQUFLQSxLQUFMLEdBQWFBLEtBQWI7QUFDQSxTQUFLQyxPQUFMLEdBQWUseUJBQWY7QUFDQSxTQUFLQyxRQUFMLEdB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QXNCRixRQUF0QixFQUE0RTtBQUMxRSxXQUFPLEtBQUt2QyxPQUFMLENBQWF3QyxFQUFiLENBQWdCLG9CQUFoQixFQUFzQ0QsUUFBdEMsQ0FBUDtBQUNEO0FBQ0RHLHlCQUF1QkgsUUFBdkIsRUFBMEQ7QUFDeEQsV0FBTyxLQUFLdkMsT0FBTCxDQUFhd0MsRUFBYixDQUFnQixzQkFBaEIsRUFBd0NELFFBQXhDLENBQVA7QUFDRDtBQUNESSxxQkFBbUJ6QixVQUFuQixFQUE4QztBQUM1QyxRQUFJQSxjQUFjLENBQUMsS0FBS25CLEtBQUwsQ0FBVzZDLFNBQVgsRUFBbkIsRUFBMkM7QUFDekMsV0FBSzdDLEtBQUwsQ0FBVzhDLElBQVg7QUFDRCxLQUZELE1BRU8sSUFBSSxDQUFDM0IsVUFBRCxJQUFlLEtBQUtuQixLQUFMLENBQVc2QyxTQUFYLEVBQW5CLEVBQTJDO0FBQ2hELFdBQUs3QyxLQUFMLENBQVcrQyxJQUFYO0FBQ0Q7QUFDRjtBQUNEN0IsWUFBVTtBQUNSLFNBQUtmLGFBQUwsQ0FBbUJlLE9BQW5CO0FBQ0Q7QUFqSGdDLEM7a0JBQWRwQixhIiwiZmlsZSI6ImRlbGVnYXRlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyogQGZsb3cgKi9cblxuaW1wb3J0IHsgUmFuZ2UgfSBmcm9tICdhdG9tJ1xuaW1wb3J0IHsgQ29tcG9zaXRlRGlzcG9zYWJsZSwgRW1pdHRlciB9IGZyb20gJ3NiLWV2ZW50LWtpdCdcbmltcG9ydCB0eXBlIHsgUGFuZWwgfSBmcm9tICdhdG9tJ1xuaW1wb3J0IHR5cGUgeyBEaXNwb3NhYmxlIH0gZnJvbSAnc2ItZXZlbnQta2l0J1xuXG5pbXBvcnQgeyBmaWx0ZXJNZXNzYWdlcywgZmlsdGVyTWVzc2FnZXNCeVJhbmdlT3JQb2ludCB9IGZyb20gJy4uL2hlbHBlcnMnXG5pbXBvcnQgdHlwZSB7IExpbnRlck1lc3NhZ2UgfSBmcm9tICcuLi90eXBlcydcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUGFuZWxEZWxlZ2F0ZSB7XG4gIHBhbmVsOiBQYW5lbDtcbiAgZW1pdHRlcjogRW1pdHRlcjtcbiAgbWVzc2FnZXM6IEFycmF5PExpbnRlck1lc3NhZ2U+O1xuICB2aXNpYmlsaXR5OiBib29sZWFuO1xuICBwYW5lbEhlaWdodDogbnVtYmVyO1xuICBzdWJzY3JpcHRpb25zOiBDb21wb3NpdGVEaXNwb3NhYmxlO1xuICBwYW5lbFJlcHJlc2VudHM6ICdFbnRpcmUgUHJvamVjdCcgfCAnQ3VycmVudCBGaWxlJyB8ICdDdXJyZW50IExpbmUnO1xuICBwYW5lbFRha2VzTWluaW11bUhlaWdodDogYm9vbGVhbjtcblxuICBjb25zdHJ1Y3RvcihwYW5lbDogUGFuZWwpIHtcbiAgICB0aGlzLnBhbmVsID0gcGFuZWxcbiAgICB0aGlzLmVtaXR0ZXIgPSBuZXcgRW1pdHRlcigpXG4gICAgdGhpcy5tZXNzYWdlcyA9IFtdXG4gICAgdGhpcy5zdWJzY3JpcHRpb25zID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuXG4gICAgdGhpcy5zdWJzY3JpcHRpb25zLmFkZChhdG9tLmNvbmZpZy5vYnNlcnZlKCdsaW50ZXItdWktZGVmYXVsdC5wYW5lbFJlcHJlc2VudHMnLCAocGFuZWxSZXByZXNlbnRzKSA9PiB7XG4gICAgICBjb25zdCBub3RJbml0aWFsID0gdHlwZW9mIHRoaXMucGFuZWxSZXByZXNlbnRzICE9PSAndW5kZWZpbmVkJ1xuICAgICAgdGhpcy5wYW5lbFJlcHJlc2VudHMgPSBwYW5lbFJlcHJlc2VudHNcbiAgICAgIGlmIChub3RJbml0aWFsKSB7XG4gICAgICAgIHRoaXMudXBkYXRlKClcbiAgICAgIH1cbiAgICB9KSlcbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMuYWRkKGF0b20uY29uZmlnLm9ic2VydmUoJ2xpbnRlci11aS1kZWZhdWx0LnBhbmVsSGVpZ2h0JywgKHBhbmVsSGVpZ2h0KSA9PiB7XG4gICAgICBjb25zdCBub3RJbml0aWFsID0gdHlwZW9mIHRoaXMucGFuZWxIZWlnaHQgIT09ICd1bmRlZmluZWQnXG4gICAgICB0aGlzLnBhbmVsSGVpZ2h0ID0gcGFuZWxIZWlnaHRcbiAgICAgIGlmIChub3RJbml0aWFsKSB7XG4gICAgICAgIHRoaXMuZW1pdHRlci5lbWl0KCdvYnNlcnZlLXBhbmVsLWNvbmZpZycpXG4gICAgICB9XG4gICAgfSkpXG4gICAgdGhpcy5zdWJzY3JpcHRpb25zLmFkZChhdG9tLmNvbmZpZy5vYnNlcnZlKCdsaW50ZXItdWktZGVmYXVsdC5wYW5lbFRha2VzTWluaW11bUhlaWdodCcsIChwYW5lbFRha2VzTWluaW11bUhlaWdodCkgPT4ge1xuICAgICAgY29uc3Qgbm90SW5pdGlhbCA9IHR5cGVvZiB0aGlzLnBhbmVsVGFrZXNNaW5pbXVtSGVpZ2h0ICE9PSAndW5kZWZpbmVkJ1xuICAgICAgdGhpcy5wYW5lbFRha2VzTWluaW11bUhlaWdodCA9IHBhbmVsVGFrZXNNaW5pbXVtSGVpZ2h0XG4gICAgICBpZiAobm90SW5pdGlhbCkge1xuICAgICAgICB0aGlzLmVtaXR0ZXIuZW1pdCgnb2JzZXJ2ZS1wYW5lbC1jb25maWcnKVxuICAgICAgfVxuICAgIH0pKVxuXG4gICAgbGV0IGNoYW5nZVN1YnNjcmlwdGlvblxuICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5hZGQoYXRvbS53b3Jrc3BhY2Uub2JzZXJ2ZUFjdGl2ZVBhbmVJdGVtKChwYW5lSXRlbSkgPT4ge1xuICAgICAgaWYgKGNoYW5nZVN1YnNjcmlwdGlvbikge1xuICAgICAgICBjaGFuZ2VTdWJzY3JpcHRpb24uZGlzcG9zZSgpXG4gICAgICAgIGNoYW5nZVN1YnNjcmlwdGlvbiA9IG51bGxcbiAgICAgIH1cbiAgICAgIHRoaXMudmlzaWJpbGl0eSA9IGF0b20ud29ya3NwYWNlLmlzVGV4dEVkaXRvcihwYW5lSXRlbSlcbiAgICAgIHRoaXMuZW1pdHRlci5lbWl0KCdvYnNlcnZlLXZpc2liaWxpdHknLCB0aGlzLnZpc2liaWxpdHkpXG4gICAgICBpZiAodGhpcy52aXNpYmlsaXR5KSB7XG4gICAgICAgIGlmICh0aGlzLnBhbmVsUmVwcmVzZW50cyAhPT0gJ0VudGlyZSBQcm9qZWN0Jykge1xuICAgICAgICAgIHRoaXMudXBkYXRlKClcbiAgICAgICAgfVxuICAgICAgICBsZXQgb2xkUm93ID0gLTFcbiAgICAgICAgY2hhbmdlU3Vic2NyaXB0aW9uID0gcGFuZUl0ZW0ub25EaWRDaGFuZ2VDdXJzb3JQb3NpdGlvbigoeyBuZXdCdWZmZXJQb3NpdGlvbiB9KSA9PiB7XG4gICAgICAgICAgaWYgKG9sZFJvdyAhPT0gbmV3QnVmZmVyUG9zaXRpb24ucm93ICYmIHRoaXMucGFuZWxSZXByZXNlbnRzID09PSAnQ3VycmVudCBMaW5lJykge1xuICAgICAgICAgICAgb2xkUm93ID0gbmV3QnVmZmVyUG9zaXRpb24ucm93XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZSgpXG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgfVxuICAgICAgY29uc3Qgc2hvdWxkVXBkYXRlID0gdHlwZW9mIHRoaXMudmlzaWJpbGl0eSAhPT0gJ3VuZGVmaW5lZCcgJiYgdGhpcy5wYW5lbFJlcHJlc2VudHMgIT09ICdFbnRpcmUgUHJvamVjdCdcblxuICAgICAgaWYgKHRoaXMudmlzaWJpbGl0eSAmJiBzaG91bGRVcGRhdGUpIHtcbiAgICAgICAgdGhpcy51cGRhdGUoKVxuICAgICAgfVxuICAgIH0pKVxuICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5hZGQoZnVuY3Rpb24oKSB7XG4gICAgICBpZiAoY2hhbmdlU3Vic2NyaXB0aW9uKSB7XG4gICAgICAgIGNoYW5nZVN1YnNjcmlwdGlvbi5kaXNwb3NlKClcbiAgICAgIH1cbiAgICB9KVxuICB9XG4gIGdldCBmaWx0ZXJlZE1lc3NhZ2VzKCk6IEFycmF5PExpbnRlck1lc3NhZ2U+IHtcbiAgICBsZXQgZmlsdGVyZWRNZXNzYWdlcyA9IFtdXG4gICAgaWYgKHRoaXMucGFuZWxSZXByZXNlbnRzID09PSAnRW50aXJlIFByb2plY3QnKSB7XG4gICAgICBmaWx0ZXJlZE1lc3NhZ2VzID0gdGhpcy5tZXNzYWdlc1xuICAgIH0gZWxzZSBpZiAodGhpcy5wYW5lbFJlcHJlc2VudHMgPT09ICdDdXJyZW50IEZpbGUnKSB7XG4gICAgICBjb25zdCBhY3RpdmVFZGl0b3IgPSBhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVUZXh0RWRpdG9yKClcbiAgICAgIGlmICghYWN0aXZlRWRpdG9yKSByZXR1cm4gW11cbiAgICAgIGZpbHRlcmVkTWVzc2FnZXMgPSBmaWx0ZXJNZXNzYWdlcyh0aGlzLm1lc3NhZ2VzLCBhY3RpdmVFZGl0b3IuZ2V0UGF0aCgpKVxuICAgIH0gZWxzZSBpZiAodGhpcy5wYW5lbFJlcHJlc2VudHMgPT09ICdDdXJyZW50IExpbmUnKSB7XG4gICAgICBjb25zdCBhY3RpdmVFZGl0b3IgPSBhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVUZXh0RWRpdG9yKClcbiAgICAgIGlmICghYWN0aXZlRWRpdG9yKSByZXR1cm4gW11cbiAgICAgIGNvbnN0IGFjdGl2ZUxpbmUgPSBhY3RpdmVFZGl0b3IuZ2V0Q3Vyc29ycygpWzBdLmdldEJ1ZmZlclJvdygpXG4gICAgICBmaWx0ZXJlZE1lc3NhZ2VzID0gZmlsdGVyTWVzc2FnZXNCeVJhbmdlT3JQb2ludCh0aGlzLm1lc3NhZ2VzLCBhY3RpdmVFZGl0b3IuZ2V0UGF0aCgpLCBSYW5nZS5mcm9tT2JqZWN0KFtbYWN0aXZlTGluZSwgMF0sIFthY3RpdmVMaW5lLCBJbmZpbml0eV1dKSlcbiAgICB9XG4gICAgcmV0dXJuIGZpbHRlcmVkTWVzc2FnZXNcbiAgfVxuICB1cGRhdGUobWVzc2FnZXM6ID9BcnJheTxMaW50ZXJNZXNzYWdlPiA9IG51bGwpOiB2b2lkIHtcbiAgICBpZiAoQXJyYXkuaXNBcnJheShtZXNzYWdlcykpIHtcbiAgICAgIHRoaXMubWVzc2FnZXMgPSBtZXNzYWdlc1xuICAgIH1cbiAgICB0aGlzLmVtaXR0ZXIuZW1pdCgnb2JzZXJ2ZS1tZXNzYWdlcycsIHRoaXMuZmlsdGVyZWRNZXNzYWdlcylcbiAgfVxuICB1cGRhdGVQYW5lbEhlaWdodChwYW5lbEhlaWdodDogbnVtYmVyKTogdm9pZCB7XG4gICAgYXRvbS5jb25maWcuc2V0KCdsaW50ZXItdWktZGVmYXVsdC5wYW5lbEhlaWdodCcsIHBhbmVsSGVpZ2h0KVxuICB9XG4gIG9uRGlkQ2hhbmdlTWVzc2FnZXMoY2FsbGJhY2s6ICgobWVzc2FnZXM6IEFycmF5PExpbnRlck1lc3NhZ2U+KSA9PiBhbnkpKTogRGlzcG9zYWJsZSB7XG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5vbignb2JzZXJ2ZS1tZXNzYWdlcycsIGNhbGxiYWNrKVxuICB9XG4gIG9uRGlkQ2hhbmdlVmlzaWJpbGl0eShjYWxsYmFjazogKCh2aXNpYmlsaXR5OiBib29sZWFuKSA9PiBhbnkpKTogRGlzcG9zYWJsZSB7XG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5vbignb2JzZXJ2ZS12aXNpYmlsaXR5JywgY2FsbGJhY2spXG4gIH1cbiAgb25EaWRDaGFuZ2VQYW5lbENvbmZpZyhjYWxsYmFjazogKCgpID0+IGFueSkpOiBEaXNwb3NhYmxlIHtcbiAgICByZXR1cm4gdGhpcy5lbWl0dGVyLm9uKCdvYnNlcnZlLXBhbmVsLWNvbmZpZycsIGNhbGxiYWNrKVxuICB9XG4gIHNldFBhbmVsVmlzaWJpbGl0eSh2aXNpYmlsaXR5OiBib29sZWFuKTogdm9pZCB7XG4gICAgaWYgKHZpc2liaWxpdHkgJiYgIXRoaXMucGFuZWwuaXNWaXNpYmxlKCkpIHtcbiAgICAgIHRoaXMucGFuZWwuc2hvdygpXG4gICAgfSBlbHNlIGlmICghdmlzaWJpbGl0eSAmJiB0aGlzLnBhbmVsLmlzVmlzaWJsZSgpKSB7XG4gICAgICB0aGlzLnBhbmVsLmhpZGUoKVxuICAgIH1cbiAgfVxuICBkaXNwb3NlKCkge1xuICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5kaXNwb3NlKClcbiAgfVxufVxuIl19