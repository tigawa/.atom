Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _atom = require('atom');

var _sbDebounce = require('sb-debounce');

var _sbDebounce2 = _interopRequireDefault(_sbDebounce);

var _helpers = require('./helpers');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

let MessageRegistry = class MessageRegistry {

  constructor() {
    this.emitter = new _atom.Emitter();
    this.messages = [];
    this.messagesMap = new Set();
    this.subscriptions = new _atom.CompositeDisposable();
    this.debouncedUpdate = (0, _sbDebounce2.default)(this.update, 100, true);

    this.subscriptions.add(this.emitter);
  }
  set({ messages, linter, buffer }) {
    let found = null;
    for (const entry of this.messagesMap) {
      if (entry.buffer === buffer && entry.linter === linter) {
        found = entry;
        break;
      }
    }

    if (found) {
      found.messages = messages;
      found.changed = true;
    } else {
      this.messagesMap.add({ messages, linter, buffer, oldMessages: [], changed: true, deleted: false });
    }
    this.debouncedUpdate();
  }
  update() {
    const result = { added: [], removed: [], messages: [] };

    for (const entry of this.messagesMap) {
      if (entry.deleted) {
        result.removed = result.removed.concat(entry.oldMessages);
        this.messagesMap.delete(entry);
        continue;
      }
      if (!entry.changed) {
        result.messages = result.messages.concat(entry.oldMessages);
        continue;
      }
      entry.changed = false;
      if (!entry.oldMessages.length) {
        // All messages are new, no need to diff
        // NOTE: No need to add .key here because normalizeMessages already does that
        result.added = result.added.concat(entry.messages);
        result.messages = result.messages.concat(entry.messages);
        entry.oldMessages = entry.messages;
        continue;
      }
      if (!entry.messages.length) {
        // All messages are old, no need to diff
        result.removed = result.removed.concat(entry.oldMessages);
        entry.oldMessages = [];
        continue;
      }

      const newKeys = new Set();
      const oldKeys = new Set();
      const oldMessages = entry.oldMessages;
      let foundNew = false;
      entry.oldMessages = [];

      for (let i = 0, length = oldMessages.length; i < length; ++i) {
        const message = oldMessages[i];
        if (message.version === 2) {
          message.key = (0, _helpers.messageKey)(message);
        } else {
          message.key = (0, _helpers.messageKeyLegacy)(message);
        }
        oldKeys.add(message.key);
      }

      for (let i = 0, length = entry.messages.length; i < length; ++i) {
        const message = entry.messages[i];
        if (newKeys.has(message.key)) {
          continue;
        }
        newKeys.add(message.key);
        if (!oldKeys.has(message.key)) {
          foundNew = true;
          result.added.push(message);
          result.messages.push(message);
          entry.oldMessages.push(message);
        }
      }

      if (!foundNew && entry.messages.length === oldMessages.length) {
        // Messages are unchanged
        result.messages = result.messages.concat(oldMessages);
        entry.oldMessages = oldMessages;
        continue;
      }

      for (let i = 0, length = oldMessages.length; i < length; ++i) {
        const message = oldMessages[i];
        if (newKeys.has(message.key)) {
          entry.oldMessages.push(message);
          result.messages.push(message);
        } else {
          result.removed.push(message);
        }
      }
    }

    if (result.added.length || result.removed.length) {
      this.messages = result.messages;
      this.emitter.emit('did-update-messages', result);
    }
  }
  onDidUpdateMessages(callback) {
    return this.emitter.on('did-update-messages', callback);
  }
  deleteByBuffer(buffer) {
    for (const entry of this.messagesMap) {
      if (entry.buffer === buffer) {
        entry.deleted = true;
      }
    }
    this.debouncedUpdate();
  }
  deleteByLinter(linter) {
    for (const entry of this.messagesMap) {
      if (entry.linter === linter) {
        entry.deleted = true;
      }
    }
    this.debouncedUpdate();
  }
  dispose() {
    this.subscriptions.dispose();
  }
};
exports.default = MessageRegistry;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1lc3NhZ2UtcmVnaXN0cnkuanMiXSwibmFtZXMiOlsiTWVzc2FnZVJlZ2lzdHJ5IiwiY29uc3RydWN0b3IiLCJlbWl0dGVyIiwibWVzc2FnZXMiLCJtZXNzYWdlc01hcCIsIlNldCIsInN1YnNjcmlwdGlvbnMiLCJkZWJvdW5jZWRVcGRhdGUiLCJ1cGRhdGUiLCJhZGQiLCJzZXQiLCJsaW50ZXIiLCJidWZmZXIiLCJmb3VuZCIsImVudHJ5IiwiY2hhbmdlZCIsIm9sZE1lc3NhZ2VzIiwiZGVsZXRlZCIsInJlc3VsdCIsImFkZGVkIiwicmVtb3ZlZCIsImNvbmNhdCIsImRlbGV0ZSIsImxlbmd0aCIsIm5ld0tleXMiLCJvbGRLZXlzIiwiZm91bmROZXciLCJpIiwibWVzc2FnZSIsInZlcnNpb24iLCJrZXkiLCJoYXMiLCJwdXNoIiwiZW1pdCIsIm9uRGlkVXBkYXRlTWVzc2FnZXMiLCJjYWxsYmFjayIsIm9uIiwiZGVsZXRlQnlCdWZmZXIiLCJkZWxldGVCeUxpbnRlciIsImRpc3Bvc2UiXSwibWFwcGluZ3MiOiI7Ozs7O0FBRUE7O0FBQ0E7Ozs7QUFFQTs7OztJQVlxQkEsZSxHQUFOLE1BQU1BLGVBQU4sQ0FBc0I7O0FBT25DQyxnQkFBYztBQUNaLFNBQUtDLE9BQUwsR0FBZSxtQkFBZjtBQUNBLFNBQUtDLFFBQUwsR0FBZ0IsRUFBaEI7QUFDQSxTQUFLQyxXQUFMLEdBQW1CLElBQUlDLEdBQUosRUFBbkI7QUFDQSxTQUFLQyxhQUFMLEdBQXFCLCtCQUFyQjtBQUNBLFNBQUtDLGVBQUwsR0FBdUIsMEJBQVMsS0FBS0MsTUFBZCxFQUFzQixHQUF0QixFQUEyQixJQUEzQixDQUF2Qjs7QUFFQSxTQUFLRixhQUFMLENBQW1CRyxHQUFuQixDQUF1QixLQUFLUCxPQUE1QjtBQUNEO0FBQ0RRLE1BQUksRUFBRVAsUUFBRixFQUFZUSxNQUFaLEVBQW9CQyxNQUFwQixFQUFKLEVBQW9IO0FBQ2xILFFBQUlDLFFBQVEsSUFBWjtBQUNBLFNBQUssTUFBTUMsS0FBWCxJ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QUFPQyxLQUFQLENBQWFJLE1BQWIsSUFBdUJMLE9BQU9FLE9BQVAsQ0FBZUcsTUFBMUMsRUFBa0Q7QUFDaEQsV0FBS3BCLFFBQUwsR0FBZ0JlLE9BQU9mLFFBQXZCO0FBQ0EsV0FBS0QsT0FBTCxDQUFhK0IsSUFBYixDQUFrQixxQkFBbEIsRUFBeUNmLE1BQXpDO0FBQ0Q7QUFDRjtBQUNEZ0Isc0JBQW9CQyxRQUFwQixFQUFpRjtBQUMvRSxXQUFPLEtBQUtqQyxPQUFMLENBQWFrQyxFQUFiLENBQWdCLHFCQUFoQixFQUF1Q0QsUUFBdkMsQ0FBUDtBQUNEO0FBQ0RFLGlCQUFlekIsTUFBZixFQUFtQztBQUNqQyxTQUFLLE1BQU1FLEtBQVgsSUFBb0IsS0FBS1YsV0FBekIsRUFBc0M7QUFDcEMsVUFBSVUsTUFBTUYsTUFBTixLQUFpQkEsTUFBckIsRUFBNkI7QUFDM0JFLGNBQU1HLE9BQU4sR0FBZ0IsSUFBaEI7QUFDRDtBQUNGO0FBQ0QsU0FBS1YsZUFBTDtBQUNEO0FBQ0QrQixpQkFBZTNCLE1BQWYsRUFBK0I7QUFDN0IsU0FBSyxNQUFNRyxLQUFYLElBQW9CLEtBQUtWLFdBQXpCLEVBQXNDO0FBQ3BDLFVBQUlVLE1BQU1ILE1BQU4sS0FBaUJBLE1BQXJCLEVBQTZCO0FBQzNCRyxjQUFNRyxPQUFOLEdBQWdCLElBQWhCO0FBQ0Q7QUFDRjtBQUNELFNBQUtWLGVBQUw7QUFDRDtBQUNEZ0MsWUFBVTtBQUNSLFNBQUtqQyxhQUFMLENBQW1CaUMsT0FBbkI7QUFDRDtBQXhJa0MsQztrQkFBaEJ2QyxlIiwiZmlsZSI6Im1lc3NhZ2UtcmVnaXN0cnkuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBAZmxvdyAqL1xuXG5pbXBvcnQgeyBDb21wb3NpdGVEaXNwb3NhYmxlLCBFbWl0dGVyIH0gZnJvbSAnYXRvbSdcbmltcG9ydCBkZWJvdW5jZSBmcm9tICdzYi1kZWJvdW5jZSdcbmltcG9ydCB0eXBlIHsgRGlzcG9zYWJsZSwgVGV4dEJ1ZmZlciB9IGZyb20gJ2F0b20nXG5pbXBvcnQgeyBtZXNzYWdlS2V5LCBtZXNzYWdlS2V5TGVnYWN5IH0gZnJvbSAnLi9oZWxwZXJzJ1xuaW1wb3J0IHR5cGUgeyBNZXNzYWdlc1BhdGNoLCBNZXNzYWdlLCBNZXNzYWdlTGVnYWN5LCBMaW50ZXIgfSBmcm9tICcuL3R5cGVzJ1xuXG50eXBlIExpbnRlciRNZXNzYWdlJE1hcCA9IHtcbiAgYnVmZmVyOiA/VGV4dEJ1ZmZlcixcbiAgbGludGVyOiBMaW50ZXIsXG4gIGNoYW5nZWQ6IGJvb2xlYW4sXG4gIGRlbGV0ZWQ6IGJvb2xlYW4sXG4gIG1lc3NhZ2VzOiBBcnJheTxNZXNzYWdlIHwgTWVzc2FnZUxlZ2FjeT4sXG4gIG9sZE1lc3NhZ2VzOiBBcnJheTxNZXNzYWdlIHwgTWVzc2FnZUxlZ2FjeT5cbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgTWVzc2FnZVJlZ2lzdHJ5IHtcbiAgZW1pdHRlcjogRW1pdHRlcjtcbiAgbWVzc2FnZXM6IEFycmF5PE1lc3NhZ2UgfCBNZXNzYWdlTGVnYWN5PjtcbiAgbWVzc2FnZXNNYXA6IFNldDxMaW50ZXIkTWVzc2FnZSRNYXA+O1xuICBzdWJzY3JpcHRpb25zOiBDb21wb3NpdGVEaXNwb3NhYmxlO1xuICBkZWJvdW5jZWRVcGRhdGU6ICgoKSA9PiB2b2lkKTtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLmVtaXR0ZXIgPSBuZXcgRW1pdHRlcigpXG4gICAgdGhpcy5tZXNzYWdlcyA9IFtdXG4gICAgdGhpcy5tZXNzYWdlc01hcCA9IG5ldyBTZXQoKVxuICAgIHRoaXMuc3Vic2NyaXB0aW9ucyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgICB0aGlzLmRlYm91bmNlZFVwZGF0ZSA9IGRlYm91bmNlKHRoaXMudXBkYXRlLCAxMDAsIHRydWUpXG5cbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMuYWRkKHRoaXMuZW1pdHRlcilcbiAgfVxuICBzZXQoeyBtZXNzYWdlcywgbGludGVyLCBidWZmZXIgfTogeyBtZXNzYWdlczogQXJyYXk8TWVzc2FnZSB8IE1lc3NhZ2VMZWdhY3k+LCBsaW50ZXI6IExpbnRlciwgYnVmZmVyOiBUZXh0QnVmZmVyIH0pIHtcbiAgICBsZXQgZm91bmQgPSBudWxsXG4gICAgZm9yIChjb25zdCBlbnRyeSBvZiB0aGlzLm1lc3NhZ2VzTWFwKSB7XG4gICAgICBpZiAoZW50cnkuYnVmZmVyID09PSBidWZmZXIgJiYgZW50cnkubGludGVyID09PSBsaW50ZXIpIHtcbiAgICAgICAgZm91bmQgPSBlbnRyeVxuICAgICAgICBicmVha1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChmb3VuZCkge1xuICAgICAgZm91bmQubWVzc2FnZXMgPSBtZXNzYWdlc1xuICAgICAgZm91bmQuY2hhbmdlZCA9IHRydWVcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5tZXNzYWdlc01hcC5hZGQoeyBtZXNzYWdlcywgbGludGVyLCBidWZmZXIsIG9sZE1lc3NhZ2VzOiBbXSwgY2hhbmdlZDogdHJ1ZSwgZGVsZXRlZDogZmFsc2UgfSlcbiAgICB9XG4gICAgdGhpcy5kZWJvdW5jZWRVcGRhdGUoKVxuICB9XG4gIHVwZGF0ZSgpIHtcbiAgICBjb25zdCByZXN1bHQgPSB7IGFkZGVkOiBbXSwgcmVtb3ZlZDogW10sIG1lc3NhZ2VzOiBbXSB9XG5cbiAgICBmb3IgKGNvbnN0IGVudHJ5IG9mIHRoaXMubWVzc2FnZXNNYXApIHtcbiAgICAgIGlmIChlbnRyeS5kZWxldGVkKSB7XG4gICAgICAgIHJlc3VsdC5yZW1vdmVkID0gcmVzdWx0LnJlbW92ZWQuY29uY2F0KGVudHJ5Lm9sZE1lc3NhZ2VzKVxuICAgICAgICB0aGlzLm1lc3NhZ2VzTWFwLmRlbGV0ZShlbnRyeSlcbiAgICAgICAgY29udGludWVcbiAgICAgIH1cbiAgICAgIGlmICghZW50cnkuY2hhbmdlZCkge1xuICAgICAgICByZXN1bHQubWVzc2FnZXMgPSByZXN1bHQubWVzc2FnZXMuY29uY2F0KGVudHJ5Lm9sZE1lc3NhZ2VzKVxuICAgICAgICBjb250aW51ZVxuICAgICAgfVxuICAgICAgZW50cnkuY2hhbmdlZCA9IGZhbHNlXG4gICAgICBpZiAoIWVudHJ5Lm9sZE1lc3NhZ2VzLmxlbmd0aCkge1xuICAgICAgICAvLyBBbGwgbWVzc2FnZXMgYXJlIG5ldywgbm8gbmVlZCB0byBkaWZmXG4gICAgICAgIC8vIE5PVEU6IE5vIG5lZWQgdG8gYWRkIC5rZXkgaGVyZSBiZWNhdXNlIG5vcm1hbGl6ZU1lc3NhZ2VzIGFscmVhZHkgZG9lcyB0aGF0XG4gICAgICAgIHJlc3VsdC5hZGRlZCA9IHJlc3VsdC5hZGRlZC5jb25jYXQoZW50cnkubWVzc2FnZXMpXG4gICAgICAgIHJlc3VsdC5tZXNzYWdlcyA9IHJlc3VsdC5tZXNzYWdlcy5jb25jYXQoZW50cnkubWVzc2FnZXMpXG4gICAgICAgIGVudHJ5Lm9sZE1lc3NhZ2VzID0gZW50cnkubWVzc2FnZXNcbiAgICAgICAgY29udGludWVcbiAgICAgIH1cbiAgICAgIGlmICghZW50cnkubWVzc2FnZXMubGVuZ3RoKSB7XG4gICAgICAgIC8vIEFsbCBtZXNzYWdlcyBhcmUgb2xkLCBubyBuZWVkIHRvIGRpZmZcbiAgICAgICAgcmVzdWx0LnJlbW92ZWQgPSByZXN1bHQucmVtb3ZlZC5jb25jYXQoZW50cnkub2xkTWVzc2FnZXMpXG4gICAgICAgIGVudHJ5Lm9sZE1lc3NhZ2VzID0gW11cbiAgICAgICAgY29udGludWVcbiAgICAgIH1cblxuICAgICAgY29uc3QgbmV3S2V5cyA9IG5ldyBTZXQoKVxuICAgICAgY29uc3Qgb2xkS2V5cyA9IG5ldyBTZXQoKVxuICAgICAgY29uc3Qgb2xkTWVzc2FnZXMgPSBlbnRyeS5vbGRNZXNzYWdlc1xuICAgICAgbGV0IGZvdW5kTmV3ID0gZmFsc2VcbiAgICAgIGVudHJ5Lm9sZE1lc3NhZ2VzID0gW11cblxuICAgICAgZm9yIChsZXQgaSA9IDAsIGxlbmd0aCA9IG9sZE1lc3NhZ2VzLmxlbmd0aDsgaSA8IGxlbmd0aDsgKytpKSB7XG4gICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBvbGRNZXNzYWdlc1tpXVxuICAgICAgICBpZiAobWVzc2FnZS52ZXJzaW9uID09PSAyKSB7XG4gICAgICAgICAgbWVzc2FnZS5rZXkgPSBtZXNzYWdlS2V5KG1lc3NhZ2UpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbWVzc2FnZS5rZXkgPSBtZXNzYWdlS2V5TGVnYWN5KG1lc3NhZ2UpXG4gICAgICAgIH1cbiAgICAgICAgb2xkS2V5cy5hZGQobWVzc2FnZS5rZXkpXG4gICAgICB9XG5cbiAgICAgIGZvciAobGV0IGkgPSAwLCBsZW5ndGggPSBlbnRyeS5tZXNzYWdlcy5sZW5ndGg7IGkgPCBsZW5ndGg7ICsraSkge1xuICAgICAgICBjb25zdCBtZXNzYWdlID0gZW50cnkubWVzc2FnZXNbaV1cbiAgICAgICAgaWYgKG5ld0tleXMuaGFzKG1lc3NhZ2Uua2V5KSkge1xuICAgICAgICAgIGNvbnRpbnVlXG4gICAgICAgIH1cbiAgICAgICAgbmV3S2V5cy5hZGQobWVzc2FnZS5rZXkpXG4gICAgICAgIGlmICghb2xkS2V5cy5oYXMobWVzc2FnZS5rZXkpKSB7XG4gICAgICAgICAgZm91bmROZXcgPSB0cnVlXG4gICAgICAgICAgcmVzdWx0LmFkZGVkLnB1c2gobWVzc2FnZSlcbiAgICAgICAgICByZXN1bHQubWVzc2FnZXMucHVzaChtZXNzYWdlKVxuICAgICAgICAgIGVudHJ5Lm9sZE1lc3NhZ2VzLnB1c2gobWVzc2FnZSlcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAoIWZvdW5kTmV3ICYmIGVudHJ5Lm1lc3NhZ2VzLmxlbmd0aCA9PT0gb2xkTWVzc2FnZXMubGVuZ3RoKSB7XG4gICAgICAgIC8vIE1lc3NhZ2VzIGFyZSB1bmNoYW5nZWRcbiAgICAgICAgcmVzdWx0Lm1lc3NhZ2VzID0gcmVzdWx0Lm1lc3NhZ2VzLmNvbmNhdChvbGRNZXNzYWdlcylcbiAgICAgICAgZW50cnkub2xkTWVzc2FnZXMgPSBvbGRNZXNzYWdlc1xuICAgICAgICBjb250aW51ZVxuICAgICAgfVxuXG4gICAgICBmb3IgKGxldCBpID0gMCwgbGVuZ3RoID0gb2xkTWVzc2FnZXMubGVuZ3RoOyBpIDwgbGVuZ3RoOyArK2kpIHtcbiAgICAgICAgY29uc3QgbWVzc2FnZSA9IG9sZE1lc3NhZ2VzW2ldXG4gICAgICAgIGlmIChuZXdLZXlzLmhhcyhtZXNzYWdlLmtleSkpIHtcbiAgICAgICAgICBlbnRyeS5vbGRNZXNzYWdlcy5wdXNoKG1lc3NhZ2UpXG4gICAgICAgICAgcmVzdWx0Lm1lc3NhZ2VzLnB1c2gobWVzc2FnZSlcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXN1bHQucmVtb3ZlZC5wdXNoKG1lc3NhZ2UpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAocmVzdWx0LmFkZGVkLmxlbmd0aCB8fCByZXN1bHQucmVtb3ZlZC5sZW5ndGgpIHtcbiAgICAgIHRoaXMubWVzc2FnZXMgPSByZXN1bHQubWVzc2FnZXNcbiAgICAgIHRoaXMuZW1pdHRlci5lbWl0KCdkaWQtdXBkYXRlLW1lc3NhZ2VzJywgcmVzdWx0KVxuICAgIH1cbiAgfVxuICBvbkRpZFVwZGF0ZU1lc3NhZ2VzKGNhbGxiYWNrOiAoKGRpZmZlcmVuY2U6IE1lc3NhZ2VzUGF0Y2gpID0+IHZvaWQpKTogRGlzcG9zYWJsZSB7XG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5vbignZGlkLXVwZGF0ZS1tZXNzYWdlcycsIGNhbGxiYWNrKVxuICB9XG4gIGRlbGV0ZUJ5QnVmZmVyKGJ1ZmZlcjogVGV4dEJ1ZmZlcikge1xuICAgIGZvciAoY29uc3QgZW50cnkgb2YgdGhpcy5tZXNzYWdlc01hcCkge1xuICAgICAgaWYgKGVudHJ5LmJ1ZmZlciA9PT0gYnVmZmVyKSB7XG4gICAgICAgIGVudHJ5LmRlbGV0ZWQgPSB0cnVlXG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuZGVib3VuY2VkVXBkYXRlKClcbiAgfVxuICBkZWxldGVCeUxpbnRlcihsaW50ZXI6IExpbnRlcikge1xuICAgIGZvciAoY29uc3QgZW50cnkgb2YgdGhpcy5tZXNzYWdlc01hcCkge1xuICAgICAgaWYgKGVudHJ5LmxpbnRlciA9PT0gbGludGVyKSB7XG4gICAgICAgIGVudHJ5LmRlbGV0ZWQgPSB0cnVlXG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuZGVib3VuY2VkVXBkYXRlKClcbiAgfVxuICBkaXNwb3NlKCkge1xuICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5kaXNwb3NlKClcbiAgfVxufVxuIl19