Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.LINTER_CONFIG_FILE_OPTIONS = exports.LINTER_CONFIG_FILE_DEFAULT = exports.LINTER_CONFIG_FILE_PATH = exports.$requestLastReceived = exports.$requestLatest = exports.$activated = exports.$version = undefined;
exports.getConfigFile = getConfigFile;
exports.shouldTriggerLinter = shouldTriggerLinter;
exports.getEditorCursorScopes = getEditorCursorScopes;
exports.isPathIgnored = isPathIgnored;
exports.subscriptiveObserve = subscriptiveObserve;
exports.messageKey = messageKey;
exports.normalizeMessages = normalizeMessages;
exports.messageKeyLegacy = messageKeyLegacy;
exports.normalizeMessagesLegacy = normalizeMessagesLegacy;

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _minimatch = require('minimatch');

var _minimatch2 = _interopRequireDefault(_minimatch);

var _lodash = require('lodash.uniq');

var _lodash2 = _interopRequireDefault(_lodash);

var _sbConfigFile = require('sb-config-file');

var _sbConfigFile2 = _interopRequireDefault(_sbConfigFile);

var _atom = require('atom');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const $version = exports.$version = '__$sb_linter_version';

const $activated = exports.$activated = '__$sb_linter_activated';
const $requestLatest = exports.$requestLatest = '__$sb_linter_request_latest';
const $requestLastReceived = exports.$requestLastReceived = '__$sb_linter_request_last_received';

const LINTER_CONFIG_FILE_PATH = exports.LINTER_CONFIG_FILE_PATH = _path2.default.join(atom.getConfigDirPath(), 'linter-config.json');
const LINTER_CONFIG_FILE_DEFAULT = exports.LINTER_CONFIG_FILE_DEFAULT = {
  disabled: [],
  greeter: {
    shown: []
  }
};
const LINTER_CONFIG_FILE_OPTIONS = exports.LINTER_CONFIG_FILE_OPTIONS = {
  prettyPrint: true,
  createIfNonExistent: false
};
function getConfigFile() {
  return _sbConfigFile2.default.get(LINTER_CONFIG_FILE_PATH, LINTER_CONFIG_FILE_DEFAULT, LINTER_CONFIG_FILE_OPTIONS);
}

function shouldTriggerLinter(linter, wasTriggeredOnChange, scopes) {
  if (wasTriggeredOnChange && !(linter[$version] === 2 ? linter.lintsOnChange : linter.lintOnFly)) {
    return false;
  }
  return scopes.some(function (scope) {
    return linter.grammarScopes.includes(scope);
  });
}

function getEditorCursorScopes(textEditor) {
  return (0, _lodash2.default)(textEditor.getCursors().reduce((scopes, cursor) => scopes.concat(cursor.getScopeDescriptor().getScopesArray()), ['*']));
}

function isPathIgnored(filePath, ignoredGlob, ignoredVCS) {
  if (ignoredVCS) {
    let repository = null;
    const projectPaths = atom.project.getPaths();
    for (let i = 0, length = projectPaths.length; i < length; ++i) {
      const projectPath = projectPaths[i];
      if (filePath.indexOf(projectPath) === 0) {
        repository = atom.project.getRepositories()[i];
        break;
      }
    }
    if (repository && repository.isPathIgnored(filePath)) {
      return true;
    }
  }
  const normalizedFilePath = process.platform === 'win32' ? filePath.replace(/\\/g, '/') : filePath;
  return (0, _minimatch2.default)(normalizedFilePath, ignoredGlob);
}

function subscriptiveObserve(object, eventName, callback) {
  let subscription = null;
  const eventSubscription = object.observe(eventName, function (props) {
    if (subscription) {
      subscription.dispose();
    }
    subscription = callback.call(this, props);
  });

  return new _atom.Disposable(function () {
    eventSubscription.dispose();
    if (subscription) {
      subscription.dispose();
    }
  });
}

function messageKey(message) {
  const reference = message.reference;
  return [`$LINTER:${message.linterName}`, `$LOCATION:${message.location.file}$${message.location.position.start.row}$${message.location.position.start.column}$${message.location.position.end.row}$${message.location.position.end.column}`, reference ? `$REFERENCE:${reference.file}$${reference.position ? `${reference.position.row}$${reference.position.column}` : ''}` : '$REFERENCE:null', `$EXCERPT:${message.excerpt}`, `$SEVERITY:${message.severity}`, message.icon ? `$ICON:${message.icon}` : '$ICON:null', message.url ? `$URL:${message.url}` : '$URL:null'].join('');
}

function normalizeMessages(linterName, messages) {
  for (let i = 0, length = messages.length; i < length; ++i) {
    const message = messages[i];
    const reference = message.reference;
    if (Array.isArray(message.location.position)) {
      message.location.position = _atom.Range.fromObject(message.location.position);
    }
    if (reference && Array.isArray(reference.position)) {
      reference.position = _atom.Point.fromObject(reference.position);
    }
    if (message.solutions && message.solutions.length) {
      for (let j = 0, _length = message.solutions.length, solution; j < _length; j++) {
        solution = message.solutions[j];
        if (Array.isArray(solution.position)) {
          solution.position = _atom.Range.fromObject(solution.position);
        }
      }
    }
    message.version = 2;
    message.linterName = linterName;
    message.key = messageKey(message);
  }
}

function messageKeyLegacy(message) {
  return [`$LINTER:${message.linterName}`, `$LOCATION:${message.filePath || ''}$${message.range ? `${message.range.start.row}$${message.range.start.column}$${message.range.end.row}$${message.range.end.column}` : ''}`, `$TEXT:${message.text || ''}`, `$HTML:${message.html || ''}`, `$SEVERITY:${message.severity}`, `$TYPE:${message.type}`, `$CLASS:${message.class || ''}`].join('');
}

function normalizeMessagesLegacy(linterName, messages) {
  for (let i = 0, length = messages.length; i < length; ++i) {
    const message = messages[i];
    const fix = message.fix;
    if (message.range && message.range.constructor.name === 'Array') {
      message.range = _atom.Range.fromObject(message.range);
    }
    if (fix && fix.range.constructor.name === 'Array') {
      fix.range = _atom.Range.fromObject(fix.range);
    }
    if (!message.severity) {
      const type = message.type.toLowerCase();
      if (type === 'warning') {
        message.severity = type;
      } else if (type === 'info' || type === 'trace') {
        message.severity = 'info';
      } else {
        message.severity = 'error';
      }
    }
    message.version = 1;
    message.linterName = linterName;
    message.key = messageKeyLegacy(message);

    if (message.trace) {
      normalizeMessagesLegacy(linterName, message.trace);
    }
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhlbHBlcnMuanMiXSwibmFtZXMiOlsiZ2V0Q29uZmlnRmlsZSIsInNob3VsZFRyaWdnZXJMaW50ZXIiLCJnZXRFZGl0b3JDdXJzb3JTY29wZXMiLCJpc1BhdGhJZ25vcmVkIiwic3Vic2NyaXB0aXZlT2JzZXJ2ZSIsIm1lc3NhZ2VLZXkiLCJub3JtYWxpemVNZXNzYWdlcyIsIm1lc3NhZ2VLZXlMZWdhY3kiLCJub3JtYWxpemVNZXNzYWdlc0xlZ2FjeSIsIiR2ZXJzaW9uIiwiJGFjdGl2YXRlZCIsIiRyZXF1ZXN0TGF0ZXN0IiwiJHJlcXVlc3RMYXN0UmVjZWl2ZWQiLCJMSU5URVJfQ09ORklHX0ZJTEVfUEFUSCIsImpvaW4iLCJhdG9tIiwiZ2V0Q29uZmlnRGlyUGF0aCIsIkxJTlRFUl9DT05GSUdfRklMRV9ERUZBVUxUIiwiZGlzYWJsZWQiLCJncmVldGVyIiwic2hvd24iLCJMSU5URVJfQ09ORklHX0ZJTEVfT1BUSU9OUyIsInByZXR0eVByaW50IiwiY3JlYXRlSWZOb25FeGlzdGVudCIsImdldCIsImxpbnRlciIsIndhc1RyaWdnZXJlZE9uQ2hhbmdlIiwic2NvcGVzIiwibGludHNPbkNoYW5nZSIsImxpbnRPbkZseSIsInNvbWUiLCJzY29wZSIsImdyYW1tYXJTY29wZXMiLCJpbmNsdWRlcyIsInRleHRFZGl0b3IiLCJnZXRDdXJzb3JzIiwicmVkdWNlIiwiY3Vyc29yIiwiY29uY2F0IiwiZ2V0U2NvcGVEZXNjcmlwdG9yIiwiZ2V0U2NvcGVzQXJyYXkiLCJmaWxlUGF0aCIsImlnbm9yZWRHbG9iIiwiaWdub3JlZFZDUyIsInJlcG9zaXRvcnkiLCJwcm9qZWN0UGF0aHMiLCJwcm9qZWN0IiwiZ2V0UGF0aHMiLCJpIiwibGVuZ3RoIiwicHJvamVjdFBhdGgiLCJpbmRleE9mIiwiZ2V0UmVwb3NpdG9yaWVzIiwibm9ybWFsaXplZEZpbGVQYXRoIiwicHJvY2VzcyIsInBsYXRmb3JtIiwicmVwbGFjZSIsIm9iamVjdCIsImV2ZW50TmFtZSIsImNhbGxiYWNrIiwic3Vic2NyaXB0aW9uIiwiZXZlbnRTdWJzY3JpcHRpb24iLCJvYnNlcnZlIiwicHJvcHMiLCJkaXNwb3NlIiwiY2FsbCIsIm1lc3NhZ2UiLCJyZWZlcmVuY2UiLCJsaW50ZXJOYW1lIiwibG9jYXRpb24iLCJmaWxlIiwicG9zaXRpb24iLCJzdGFydCIsInJvdyIsImNvbHVtbiIsImVuZCIsImV4Y2VycHQiLCJzZXZlcml0eSIsImljb24iLCJ1cmwiLCJtZXNzYWdlcyIsIkFycmF5IiwiaXNBcnJheSIsImZyb21PYmplY3QiLCJzb2x1dGlvbnMiLCJqIiwiX2xlbmd0aCIsInNvbHV0aW9uIiwidmVyc2lvbiIsImtleSIsInJhbmdlIiwidGV4dCIsImh0bWwiLCJ0eXBlIiwiY2xhc3MiLCJmaXgiLCJjb25zdHJ1Y3RvciIsIm5hbWUiLCJ0b0xvd2VyQ2FzZSIsInRyYWNlIl0sIm1hcHBpbmdzIjoiOzs7O1FBMkJnQkEsYSxHQUFBQSxhO1FBSUFDLG1CLEdBQUFBLG1CO1FBYUFDLHFCLEdBQUFBLHFCO1FBTUFDLGEsR0FBQUEsYTtRQW1CQUMsbUIsR0FBQUEsbUI7UUFpQkFDLFUsR0FBQUEsVTtRQWFBQyxpQixHQUFBQSxpQjtRQXdCQUMsZ0IsR0FBQUEsZ0I7UUFZQUMsdUIsR0FBQUEsdUI7O0FBckloQjs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBSU8sTUFBTUMsOEJBQVcsc0JBQWpCOztBQUNBLE1BQU1DLGtDQUFhLHdCQUFuQjtBQUNBLE1BQU1DLDBDQUFpQiw2QkFBdkI7QUFDQSxNQUFNQyxzREFBdUIsb0NBQTdCOztBQUdBLE1BQU1DLDREQUEwQixlQUFLQyxJQUFMLENBQVVDLEtBQUtDLGdCQUFMLEVBQVYsRUFBbUMsb0JBQW5DLENBQWhDO0FBQ0EsTUFBTUMsa0VBQTZCO0FBQ3hDQyxZQUFVLEVBRDhCO0FBRXhDQyxXQUFTO0FBQ1BDLFdBQU87QUFEQTtBQUYrQixDQUFuQztBQU1BLE1BQU1DLGtFQUE2QjtBQUN4Q0MsZUFBYSxJQUQyQjtBQUV4Q0MsdUJBQXFCO0FBRm1CLENBQW5DO0FBSUEsU0FBU3ZCLGFBQVQsR0FBOEM7QUFDbkQsU0FBTyx1QkFBV3dCLEdBQVgsQ0FBZVgsdUJBQWYsRUFBd0NJLDBCQUF4QyxFQUFvRUksMEJBQXBFLENBQVA7QUFDRDs7QUFFTSxTQUFTcEIsbUJBQVQsQ0FDTHdCLE1BREssRUFFTEMsb0JBRkssRUFHTEMsTUFISyxFQUlJO0FBQ1QsTUFBSUQsd0JBQXdCLEVBQUVELE9BQU9oQixRQUFQLE1BQXFCLENBQXJCLEdBQXlCZ0IsT0FBT0csYUFBaEMsR0FBZ0RILE9BQU9JLFNBQXpELENBQTVCLEVBQWlHO0FBQy9GLFdBQU8sS0FBUDtBQUNEO0FBQ0QsU0FBT0YsT0FBT0csSUFBUCxDQUFZLFVBQVNDLEtBQVQsRUFBZ0I7QUFDakMsV0FBT04sT0FBT08sYUFBUCxDQUFxQkMsUUFBckIsQ0FBOEJGLEtBQTlCLENBQVA7QUFDRCxHQUZNLENBQVA7QUFHRDs7QUFFTSxTQUFTN0IscUJBQVQsQ0FBK0JnQyxVQUEvQixFQUFzRTtBQUMzRSxTQUFPLHNCQUFZQSxXQUFXQyxVQUFYLEdBQXdCQyxNQUF4QixDQUErQixDQUFDVCxNQUFELEVBQVNVLE1BQVQsS0FDaERWLE9BQU9XLE1BQVAsQ0FBY0QsT0FBT0Usa0JBQVAsR0FBNEJDLGNBQTVCLEVBQWQsQ0FEaUIsRUFFaEIsQ0FBQyxHQUFELENBRmdCLENBQVosQ0FBUDtBQUdEOztBQUVNLFNBQVNyQyxhQUFULENBQXVCc0MsUUFBdkIsRUFBeUNDLFdBQXpDLEVBQThEQyxVQUE5RCxFQUE0RjtBQUNqRyxNQUFJQSxVQUFKLEVBQWdCO0FBQ2QsUUFBSUMsYUFBYSxJQUFqQjtBQUNBLFVBQU1DLGVBQWU5QixLQUFLK0IsT0FBTCxDQUFhQyxRQUFiLEVBQXJCO0FBQ0EsU0FBSyxJQUFJQyxJQUFJLENBQVIsRUFBV0MsU0FBU0osYUFBYUksTUFBdEMsRUFBOENELElBQUlDLE1BQWxELEVBQTBELEVBQUVELENBQTVELEVBQStEO0FBQzdELFlBQU1FLGNBQWNMLGFBQWFHLENBQWIsQ0FBcEI7QUFDQSxVQUFJUCxTQUFTVSxPQUFULENBQWlCRCxXQUFqQixNQUFrQyxDQUF0QyxFQUF5QztBQUN2Q04scUJBQWE3QixLQUFLK0IsT0FBTCxDQUFhTSxlQUFiLEdBQStCSixDQUEvQixDQUFiO0FBQ0E7QUFDRDtBQUNGO0FBQ0QsUUFBSUosY0FBY0EsV0FBV3pDLGFBQVgsQ0FBeUJzQyxRQUF6QixDQUFsQixFQUFzRDtBQUNwRCxhQUFPLElBQVA7QUFDRDtBQUNGO0FBQ0QsUUFBTVkscUJBQXFCQyxRQUFRQyxRQUFSLEtBQXFCLE9BQXJCLEdBQStCZCxTQUFTZSxPQUFULENBQWlCLEtBQWpCLEVBQXdCLEdBQXhCLENBQS9CLEdBQThEZixRQUF6RjtBQUNBLFNBQU8seUJBQVVZLGtCQUFWLEVBQThCWCxXQUE5QixDQUFQO0FBQ0Q7O0FBRU0sU0FBU3RDLG1CQUFULENBQTZCcUQsTUFBN0IsRUFBNkNDLFNBQTdDLEVBQWdFQyxRQUFoRSxFQUFnRztBQUNyRyxNQUFJQyxlQUFlLElBQW5CO0FBQ0EsUUFBTUMsb0JBQW9CSixPQUFPSyxPQUFQLENBQWVKLFNBQWYsRUFBMEIsVUFBU0ssS0FBVCxFQUFnQjtBQUNsRSxRQUFJSCxZQUFKLEVBQWtCO0FBQ2hCQSxtQkFBYUksT0FBYjtBQUNEO0FBQ0RKLG1CQUFlRCxTQUFTTSxJQUFULENBQWMsSUFBZCxFQUFvQkYsS0FBcEIsQ0FBZjtBQUNELEdBTHlCLENBQTFCOztBQU9BLFNBQU8scUJBQWUsWUFBVztBQUMvQkYsc0JBQWtCRyxPQUFsQjtBQUNBLFFBQUlKLFlBQUosRUFBa0I7QUFDaEJBLG1CQUFhSSxPQUFiO0FBQ0Q7QUFDRixHQUxNLENBQVA7QUFNRDs7QUFFTSxTQUFTM0QsVUFBVCxDQUFvQjZELE9BQXBCLEVBQXNDO0FBQzNDLFFBQU1DLFlBQVlELFFBQVFDLFNBQTFCO0FBQ0EsU0FBTyxDQUNKLFdBQVVELFFBQVFFLFVBQVcsRUFEekIsRUFFSixhQUFZRixRQUFRRyxRQUFSLENBQWlCQyxJQUFLLElBQUdKLFFBQVFHLFFBQVIsQ0FBaUJFLFFBQWpCLENBQTBCQyxLQUExQixDQUFnQ0MsR0FBSSxJQUFHUCxRQUFRRyxRQUFSLENBQWlCRSxRQUFqQixDQUEwQkMsS0FBMUIsQ0FBZ0NFLE1BQU8sSUFBR1IsUUFBUUcsUUFBUixDQUFpQkUsUUFBakIsQ0FBMEJJLEdBQTFCLENBQThCRixHQUFJLElBQUdQLFFBQVFHLFFBQVIsQ0FBaUJFLFFBQWpCLENBQTBCSSxHQUExQixDQUE4QkQsTUFBTyxFQUY1TCxFQUdMUCxZQUFhLGNBQWFBLFVBQVVHLElBQUssSUFBR0gsVUFBVUksUUFBVixHQUFzQixHQUFFSixVQUFVSSxRQUFWLENBQW1CRSxHQUFJLElBQUdOLFVBQVVJLFFBQVYsQ0FBbUJHLE1BQU8sRUFBNUUsR0FBZ0YsRUFBRyxFQUEvSCxHQUFtSSxpQkFIOUgsRUFJSixZQUFXUixRQUFRVSxPQUFRLEVBSnZCLEVBS0osYUFBWVYsUUFBUVcsUUFBUyxFQUx6QixFQU1MWCxRQUFRWSxJQUFSLEdBQWdCLFNBQVFaLFFBQVFZLElBQUssRUFBckMsR0FBeUMsWUFOcEMsRUFPTFosUUFBUWEsR0FBUixHQUFlLFFBQU9iLFFBQVFhLEdBQUksRUFBbEMsR0FBc0MsV0FQakMsRUFRTGpFLElBUkssQ0FRQSxFQVJBLENBQVA7QUFTRDs7QUFFTSxTQUFTUixpQkFBVCxDQUEyQjhELFVBQTNCLEVBQStDWSxRQUEvQyxFQUF5RTtBQUM5RSxPQUFLLElBQUloQyxJQUFJLENBQVIsRUFBV0MsU0FBUytCLFNBQVMvQixNQUFsQyxFQUEwQ0QsSUFBSUMsTUFBOUMsRUFBc0QsRUFBRUQsQ0FBeEQsRUFBMkQ7QUFDekQsVUFBTWtCLFVBQVVjLFNBQVNoQyxDQUFULENBQWhCO0FBQ0EsVUFBTW1CLFlBQVlELFFBQVFDLFNBQTFCO0FBQ0EsUUFBSWMsTUFBTUMsT0FBTixDQUFjaEIsUUFBUUcsUUFBUixDQUFpQkUsUUFBL0IsQ0FBSixFQUE4QztBQUM1Q0wsY0FBUUcsUUFBUixDQUFpQkUsUUFBakIsR0FBNEIsWUFBTVksVUFBTixDQUFpQmpCLFFBQVFHLFFBQVIsQ0FBaUJFLFFBQWxDLENBQTVCO0FBQ0Q7QUFDRCxRQUFJSixhQUFhYyxNQUFNQyxPQUFOLENBQWNmLFVBQVVJLFFBQXhCLENBQWpCLEVBQW9EO0FBQ2xESixnQkFBVUksUUFBVixHQUFxQixZQUFNWSxVQUFOLENBQWlCaEIsVUFBVUksUUFBM0IsQ0FBckI7QUFDRDtBQUNELFFBQUlMLFFBQVFrQixTQUFSLElBQXFCbEIsUUFBUWtCLFNBQVIsQ0FBa0JuQyxNQUEzQyxFQUFtRDtBQUNqRCxXQUFLLElBQUlvQyxJQUFJLENBQVIsRUFBV0MsVUFBVXBCLFFBQVFrQixTQUFSLENBQWtCbkMsTUFBdkMsRUFBK0NzQyxRQUFwRCxFQUE4REYsSUFBSUMsT0FBbEUsRUFBMkVELEdBQTNFLEVBQWdGO0FBQzlFRSxtQkFBV3JCLFFBQVFrQixTQUFSLENBQWtCQyxDQUFsQixDQUFYO0FBQ0EsWUFBSUosTUFBTUMsT0FBTixDQUFjSyxTQUFTaEIsUUFBdkIsQ0FBSixFQUFzQztBQUNwQ2dCLG1CQUFTaEIsUUFBVCxHQUFvQixZQUFNWSxVQUFOLENBQWlCSSxTQUFTaEIsUUFBMUIsQ0FBcEI7QUFDRDtBQUNGO0FBQ0Y7QUFDREwsWUFBUXNCLE9BQVIsR0FBa0IsQ0FBbEI7QUFDQXRCLFlBQVFFLFVBQVIsR0FBcUJBLFVBQXJCO0FBQ0FGLFlBQVF1QixHQUFSLEdBQWNwRixXQUFXNkQsT0FBWCxDQUFkO0FBQ0Q7QUFDRjs7QUFFTSxTQUFTM0QsZ0JBQVQsQ0FBMEIyRCxPQUExQixFQUEwRDtBQUMvRCxTQUFPLENBQ0osV0FBVUEsUUFBUUUsVUFBVyxFQUR6QixFQUVKLGFBQVlGLFFBQVF6QixRQUFSLElBQW9CLEVBQUcsSUFBR3lCLFFBQVF3QixLQUFSLEdBQWlCLEdBQUV4QixRQUFRd0IsS0FBUixDQUFjbEIsS0FBZCxDQUFvQkMsR0FBSSxJQUFHUCxRQUFRd0IsS0FBUixDQUFjbEIsS0FBZCxDQUFvQkUsTUFBTyxJQUFHUixRQUFRd0IsS0FBUixDQUFjZixHQUFkLENBQWtCRixHQUFJLElBQUdQLFFBQVF3QixLQUFSLENBQWNmLEdBQWQsQ0FBa0JELE1BQU8sRUFBOUgsR0FBa0ksRUFBRyxFQUZ2SyxFQUdKLFNBQVFSLFFBQVF5QixJQUFSLElBQWdCLEVBQUcsRUFIdkIsRUFJSixTQUFRekIsUUFBUTBCLElBQVIsSUFBZ0IsRUFBRyxFQUp2QixFQUtKLGFBQVkxQixRQUFRVyxRQUFTLEVBTHpCLEVBTUosU0FBUVgsUUFBUTJCLElBQUssRUFOakIsRUFPSixVQUFTM0IsUUFBUTRCLEtBQVIsSUFBaUIsRUFBRyxFQVB6QixFQVFMaEYsSUFSSyxDQVFBLEVBUkEsQ0FBUDtBQVNEOztBQUVNLFNBQVNOLHVCQUFULENBQWlDNEQsVUFBakMsRUFBcURZLFFBQXJELEVBQXFGO0FBQzFGLE9BQUssSUFBSWhDLElBQUksQ0FBUixFQUFXQyxTQUFTK0IsU0FBUy9CLE1BQWxDLEVBQTBDRCxJQUFJQyxNQUE5QyxFQUFzRCxFQUFFRCxDQUF4RCxFQUEyRDtBQUN6RCxVQUFNa0IsVUFBVWMsU0FBU2hDLENBQVQsQ0FBaEI7QUFDQSxVQUFNK0MsTUFBTTdCLFFBQVE2QixHQUFwQjtBQUNBLFFBQUk3QixRQUFRd0IsS0FBUixJQUFpQnhCLFFBQVF3QixLQUFSLENBQWNNLFdBQWQsQ0FBMEJDLElBQTFCLEtBQW1DLE9BQXhELEVBQWlFO0FBQy9EL0IsY0FBUXdCLEtBQVIsR0FBZ0IsWUFBTVAsVUFBTixDQUFpQmpCLFFBQVF3QixLQUF6QixDQUFoQjtBQUNEO0FBQ0QsUUFBSUssT0FBT0EsSUFBSUwsS0FBSixDQUFVTSxXQUFWLENBQXNCQyxJQUF0QixLQUErQixPQUExQyxFQUFtRDtBQUNqREYsVUFBSUwsS0FBSixHQUFZLFlBQU1QLFVBQU4sQ0FBaUJZLElBQUlMLEtBQXJCLENBQVo7QUFDRDtBQUNELFFBQUksQ0FBQ3hCLFFBQVFXLFFBQWIsRUFBdUI7QUFDckIsWUFBTWdCLE9BQU8zQixRQUFRMkIsSUFBUixDQUFhSyxXQUFiLEVBQWI7QUFDQSxVQUFJTCxTQUFTLFNBQWIsRUFBd0I7QUFDdEIzQixnQkFBUVcsUUFBUixHQUFtQmdCLElBQW5CO0FBQ0QsT0FGRCxNQUVPLElBQUlBLFNBQVMsTUFBVCxJQUFtQkEsU0FBUyxPQUFoQyxFQUF5QztBQUM5QzNCLGdCQUFRVyxRQUFSLEdBQW1CLE1BQW5CO0FBQ0QsT0FGTSxNQUVBO0FBQ0xYLGdCQUFRVyxRQUFSLEdBQW1CLE9BQW5CO0FBQ0Q7QUFDRjtBQUNEWCxZQUFRc0IsT0FBUixHQUFrQixDQUFsQjtBQUNBdEIsWUFBUUUsVUFBUixHQUFxQkEsVUFBckI7QUFDQUYsWUFBUXVCLEdBQVIsR0FBY2xGLGlCQUFpQjJELE9BQWpCLENBQWQ7O0FBRUEsUUFBSUEsUUFBUWlDLEtBQVosRUFBbUI7QUFDakIzRiw4QkFBd0I0RCxVQUF4QixFQUFvQ0YsUUFBUWlDLEtBQTVDO0FBQ0Q7QUFDRjtBQUNGIiwiZmlsZSI6ImhlbHBlcnMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBAZmxvdyAqL1xuXG5pbXBvcnQgUGF0aCBmcm9tICdwYXRoJ1xuaW1wb3J0IG1pbmltYXRjaCBmcm9tICdtaW5pbWF0Y2gnXG5pbXBvcnQgYXJyYXlVbmlxdWUgZnJvbSAnbG9kYXNoLnVuaXEnXG5pbXBvcnQgQ29uZmlnRmlsZSBmcm9tICdzYi1jb25maWctZmlsZSdcbmltcG9ydCB7IERpc3Bvc2FibGUsIFJhbmdlLCBQb2ludCB9IGZyb20gJ2F0b20nXG5pbXBvcnQgdHlwZSB7IFRleHRFZGl0b3IgfSBmcm9tICdhdG9tJ1xuaW1wb3J0IHR5cGUgeyBMaW50ZXIsIE1lc3NhZ2UsIE1lc3NhZ2VMZWdhY3kgfSBmcm9tICcuL3R5cGVzJ1xuXG5leHBvcnQgY29uc3QgJHZlcnNpb24gPSAnX18kc2JfbGludGVyX3ZlcnNpb24nXG5leHBvcnQgY29uc3QgJGFjdGl2YXRlZCA9ICdfXyRzYl9saW50ZXJfYWN0aXZhdGVkJ1xuZXhwb3J0IGNvbnN0ICRyZXF1ZXN0TGF0ZXN0ID0gJ19fJHNiX2xpbnRlcl9yZXF1ZXN0X2xhdGVzdCdcbmV4cG9ydCBjb25zdCAkcmVxdWVzdExhc3RSZWNlaXZlZCA9ICdfXyRzYl9saW50ZXJfcmVxdWVzdF9sYXN0X3JlY2VpdmVkJ1xuXG5cbmV4cG9ydCBjb25zdCBMSU5URVJfQ09ORklHX0ZJTEVfUEFUSCA9IFBhdGguam9pbihhdG9tLmdldENvbmZpZ0RpclBhdGgoKSwgJ2xpbnRlci1jb25maWcuanNvbicpXG5leHBvcnQgY29uc3QgTElOVEVSX0NPTkZJR19GSUxFX0RFRkFVTFQgPSB7XG4gIGRpc2FibGVkOiBbXSxcbiAgZ3JlZXRlcjoge1xuICAgIHNob3duOiBbXSxcbiAgfSxcbn1cbmV4cG9ydCBjb25zdCBMSU5URVJfQ09ORklHX0ZJTEVfT1BUSU9OUyA9IHtcbiAgcHJldHR5UHJpbnQ6IHRydWUsXG4gIGNyZWF0ZUlmTm9uRXhpc3RlbnQ6IGZhbHNlLFxufVxuZXhwb3J0IGZ1bmN0aW9uIGdldENvbmZpZ0ZpbGUoKTogUHJvbWlzZTxDb25maWdGaWxlPiB7XG4gIHJldHVybiBDb25maWdGaWxlLmdldChMSU5URVJfQ09ORklHX0ZJTEVfUEFUSCwgTElOVEVSX0NPTkZJR19GSUxFX0RFRkFVTFQsIExJTlRFUl9DT05GSUdfRklMRV9PUFRJT05TKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gc2hvdWxkVHJpZ2dlckxpbnRlcihcbiAgbGludGVyOiBMaW50ZXIsXG4gIHdhc1RyaWdnZXJlZE9uQ2hhbmdlOiBib29sZWFuLFxuICBzY29wZXM6IEFycmF5PHN0cmluZz5cbik6IGJvb2xlYW4ge1xuICBpZiAod2FzVHJpZ2dlcmVkT25DaGFuZ2UgJiYgIShsaW50ZXJbJHZlcnNpb25dID09PSAyID8gbGludGVyLmxpbnRzT25DaGFuZ2UgOiBsaW50ZXIubGludE9uRmx5KSkge1xuICAgIHJldHVybiBmYWxzZVxuICB9XG4gIHJldHVybiBzY29wZXMuc29tZShmdW5jdGlvbihzY29wZSkge1xuICAgIHJldHVybiBsaW50ZXIuZ3JhbW1hclNjb3Blcy5pbmNsdWRlcyhzY29wZSlcbiAgfSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldEVkaXRvckN1cnNvclNjb3Blcyh0ZXh0RWRpdG9yOiBUZXh0RWRpdG9yKTogQXJyYXk8c3RyaW5nPiB7XG4gIHJldHVybiBhcnJheVVuaXF1ZSh0ZXh0RWRpdG9yLmdldEN1cnNvcnMoKS5yZWR1Y2UoKHNjb3BlcywgY3Vyc29yKSA9PiAoXG4gICAgc2NvcGVzLmNvbmNhdChjdXJzb3IuZ2V0U2NvcGVEZXNjcmlwdG9yKCkuZ2V0U2NvcGVzQXJyYXkoKSlcbiAgKSwgWycqJ10pKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNQYXRoSWdub3JlZChmaWxlUGF0aDogc3RyaW5nLCBpZ25vcmVkR2xvYjogc3RyaW5nLCBpZ25vcmVkVkNTOiBib29sZWFuKTogYm9vbGVhbiB7XG4gIGlmIChpZ25vcmVkVkNTKSB7XG4gICAgbGV0IHJlcG9zaXRvcnkgPSBudWxsXG4gICAgY29uc3QgcHJvamVjdFBhdGhzID0gYXRvbS5wcm9qZWN0LmdldFBhdGhzKClcbiAgICBmb3IgKGxldCBpID0gMCwgbGVuZ3RoID0gcHJvamVjdFBhdGhzLmxlbmd0aDsgaSA8IGxlbmd0aDsgKytpKSB7XG4gICAgICBjb25zdCBwcm9qZWN0UGF0aCA9IHByb2plY3RQYXRoc1tpXVxuICAgICAgaWYgKGZpbGVQYXRoLmluZGV4T2YocHJvamVjdFBhdGgpID09PSAwKSB7XG4gICAgICAgIHJlcG9zaXRvcnkgPSBhdG9tLnByb2plY3QuZ2V0UmVwb3NpdG9yaWVzKClbaV1cbiAgICAgICAgYnJlYWtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHJlcG9zaXRvcnkgJiYgcmVwb3NpdG9yeS5pc1BhdGhJZ25vcmVkKGZpbGVQYXRoKSkge1xuICAgICAgcmV0dXJuIHRydWVcbiAgICB9XG4gIH1cbiAgY29uc3Qgbm9ybWFsaXplZEZpbGVQYXRoID0gcHJvY2Vzcy5wbGF0Zm9ybSA9PT0gJ3dpbjMyJyA/IGZpbGVQYXRoLnJlcGxhY2UoL1xcXFwvZywgJy8nKSA6IGZpbGVQYXRoXG4gIHJldHVybiBtaW5pbWF0Y2gobm9ybWFsaXplZEZpbGVQYXRoLCBpZ25vcmVkR2xvYilcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHN1YnNjcmlwdGl2ZU9ic2VydmUob2JqZWN0OiBPYmplY3QsIGV2ZW50TmFtZTogc3RyaW5nLCBjYWxsYmFjazogRnVuY3Rpb24pOiBEaXNwb3NhYmxlIHtcbiAgbGV0IHN1YnNjcmlwdGlvbiA9IG51bGxcbiAgY29uc3QgZXZlbnRTdWJzY3JpcHRpb24gPSBvYmplY3Qub2JzZXJ2ZShldmVudE5hbWUsIGZ1bmN0aW9uKHByb3BzKSB7XG4gICAgaWYgKHN1YnNjcmlwdGlvbikge1xuICAgICAgc3Vic2NyaXB0aW9uLmRpc3Bvc2UoKVxuICAgIH1cbiAgICBzdWJzY3JpcHRpb24gPSBjYWxsYmFjay5jYWxsKHRoaXMsIHByb3BzKVxuICB9KVxuXG4gIHJldHVybiBuZXcgRGlzcG9zYWJsZShmdW5jdGlvbigpIHtcbiAgICBldmVudFN1YnNjcmlwdGlvbi5kaXNwb3NlKClcbiAgICBpZiAoc3Vic2NyaXB0aW9uKSB7XG4gICAgICBzdWJzY3JpcHRpb24uZGlzcG9zZSgpXG4gICAgfVxuICB9KVxufVxuXG5leHBvcnQgZnVuY3Rpb24gbWVzc2FnZUtleShtZXNzYWdlOiBNZXNzYWdlKSB7XG4gIGNvbnN0IHJlZmVyZW5jZSA9IG1lc3NhZ2UucmVmZXJlbmNlXG4gIHJldHVybiBbXG4gICAgYCRMSU5URVI6JHttZXNzYWdlLmxpbnRlck5hbWV9YCxcbiAgICBgJExPQ0FUSU9OOiR7bWVzc2FnZS5sb2NhdGlvbi5maWxlfSQke21lc3NhZ2UubG9jYXRpb24ucG9zaXRpb24uc3RhcnQucm93fSQke21lc3NhZ2UubG9jYXRpb24ucG9zaXRpb24uc3RhcnQuY29sdW1ufSQke21lc3NhZ2UubG9jYXRpb24ucG9zaXRpb24uZW5kLnJvd30kJHttZXNzYWdlLmxvY2F0aW9uLnBvc2l0aW9uLmVuZC5jb2x1bW59YCxcbiAgICByZWZlcmVuY2UgPyBgJFJFRkVSRU5DRToke3JlZmVyZW5jZS5maWxlfSQke3JlZmVyZW5jZS5wb3NpdGlvbiA/IGAke3JlZmVyZW5jZS5wb3NpdGlvbi5yb3d9JCR7cmVmZXJlbmNlLnBvc2l0aW9uLmNvbHVtbn1gIDogJyd9YCA6ICckUkVGRVJFTkNFOm51bGwnLFxuICAgIGAkRVhDRVJQVDoke21lc3NhZ2UuZXhjZXJwdH1gLFxuICAgIGAkU0VWRVJJVFk6JHttZXNzYWdlLnNldmVyaXR5fWAsXG4gICAgbWVzc2FnZS5pY29uID8gYCRJQ09OOiR7bWVzc2FnZS5pY29ufWAgOiAnJElDT046bnVsbCcsXG4gICAgbWVzc2FnZS51cmwgPyBgJFVSTDoke21lc3NhZ2UudXJsfWAgOiAnJFVSTDpudWxsJyxcbiAgXS5qb2luKCcnKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gbm9ybWFsaXplTWVzc2FnZXMobGludGVyTmFtZTogc3RyaW5nLCBtZXNzYWdlczogQXJyYXk8TWVzc2FnZT4pIHtcbiAgZm9yIChsZXQgaSA9IDAsIGxlbmd0aCA9IG1lc3NhZ2VzLmxlbmd0aDsgaSA8IGxlbmd0aDsgKytpKSB7XG4gICAgY29uc3QgbWVzc2FnZSA9IG1lc3NhZ2VzW2ldXG4gICAgY29uc3QgcmVmZXJlbmNlID0gbWVzc2FnZS5yZWZlcmVuY2VcbiAgICBpZiAoQXJyYXkuaXNBcnJheShtZXNzYWdlLmxvY2F0aW9uLnBvc2l0aW9uKSkge1xuICAgICAgbWVzc2FnZS5sb2NhdGlvbi5wb3NpdGlvbiA9IFJhbmdlLmZyb21PYmplY3QobWVzc2FnZS5sb2NhdGlvbi5wb3NpdGlvbilcbiAgICB9XG4gICAgaWYgKHJlZmVyZW5jZSAmJiBBcnJheS5pc0FycmF5KHJlZmVyZW5jZS5wb3NpdGlvbikpIHtcbiAgICAgIHJlZmVyZW5jZS5wb3NpdGlvbiA9IFBvaW50LmZyb21PYmplY3QocmVmZXJlbmNlLnBvc2l0aW9uKVxuICAgIH1cbiAgICBpZiAobWVzc2FnZS5zb2x1dGlvbnMgJiYgbWVzc2FnZS5zb2x1dGlvbnMubGVuZ3RoKSB7XG4gICAgICBmb3IgKGxldCBqID0gMCwgX2xlbmd0aCA9IG1lc3NhZ2Uuc29sdXRpb25zLmxlbmd0aCwgc29sdXRpb247IGogPCBfbGVuZ3RoOyBqKyspIHtcbiAgICAgICAgc29sdXRpb24gPSBtZXNzYWdlLnNvbHV0aW9uc1tqXVxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShzb2x1dGlvbi5wb3NpdGlvbikpIHtcbiAgICAgICAgICBzb2x1dGlvbi5wb3NpdGlvbiA9IFJhbmdlLmZyb21PYmplY3Qoc29sdXRpb24ucG9zaXRpb24pXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgbWVzc2FnZS52ZXJzaW9uID0gMlxuICAgIG1lc3NhZ2UubGludGVyTmFtZSA9IGxpbnRlck5hbWVcbiAgICBtZXNzYWdlLmtleSA9IG1lc3NhZ2VLZXkobWVzc2FnZSlcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gbWVzc2FnZUtleUxlZ2FjeShtZXNzYWdlOiBNZXNzYWdlTGVnYWN5KTogc3RyaW5nIHtcbiAgcmV0dXJuIFtcbiAgICBgJExJTlRFUjoke21lc3NhZ2UubGludGVyTmFtZX1gLFxuICAgIGAkTE9DQVRJT046JHttZXNzYWdlLmZpbGVQYXRoIHx8ICcnfSQke21lc3NhZ2UucmFuZ2UgPyBgJHttZXNzYWdlLnJhbmdlLnN0YXJ0LnJvd30kJHttZXNzYWdlLnJhbmdlLnN0YXJ0LmNvbHVtbn0kJHttZXNzYWdlLnJhbmdlLmVuZC5yb3d9JCR7bWVzc2FnZS5yYW5nZS5lbmQuY29sdW1ufWAgOiAnJ31gLFxuICAgIGAkVEVYVDoke21lc3NhZ2UudGV4dCB8fCAnJ31gLFxuICAgIGAkSFRNTDoke21lc3NhZ2UuaHRtbCB8fCAnJ31gLFxuICAgIGAkU0VWRVJJVFk6JHttZXNzYWdlLnNldmVyaXR5fWAsXG4gICAgYCRUWVBFOiR7bWVzc2FnZS50eXBlfWAsXG4gICAgYCRDTEFTUzoke21lc3NhZ2UuY2xhc3MgfHwgJyd9YCxcbiAgXS5qb2luKCcnKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gbm9ybWFsaXplTWVzc2FnZXNMZWdhY3kobGludGVyTmFtZTogc3RyaW5nLCBtZXNzYWdlczogQXJyYXk8TWVzc2FnZUxlZ2FjeT4pIHtcbiAgZm9yIChsZXQgaSA9IDAsIGxlbmd0aCA9IG1lc3NhZ2VzLmxlbmd0aDsgaSA8IGxlbmd0aDsgKytpKSB7XG4gICAgY29uc3QgbWVzc2FnZSA9IG1lc3NhZ2VzW2ldXG4gICAgY29uc3QgZml4ID0gbWVzc2FnZS5maXhcbiAgICBpZiAobWVzc2FnZS5yYW5nZSAmJiBtZXNzYWdlLnJhbmdlLmNvbnN0cnVjdG9yLm5hbWUgPT09ICdBcnJheScpIHtcbiAgICAgIG1lc3NhZ2UucmFuZ2UgPSBSYW5nZS5mcm9tT2JqZWN0KG1lc3NhZ2UucmFuZ2UpXG4gICAgfVxuICAgIGlmIChmaXggJiYgZml4LnJhbmdlLmNvbnN0cnVjdG9yLm5hbWUgPT09ICdBcnJheScpIHtcbiAgICAgIGZpeC5yYW5nZSA9IFJhbmdlLmZyb21PYmplY3QoZml4LnJhbmdlKVxuICAgIH1cbiAgICBpZiAoIW1lc3NhZ2Uuc2V2ZXJpdHkpIHtcbiAgICAgIGNvbnN0IHR5cGUgPSBtZXNzYWdlLnR5cGUudG9Mb3dlckNhc2UoKVxuICAgICAgaWYgKHR5cGUgPT09ICd3YXJuaW5nJykge1xuICAgICAgICBtZXNzYWdlLnNldmVyaXR5ID0gdHlwZVxuICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnaW5mbycgfHwgdHlwZSA9PT0gJ3RyYWNlJykge1xuICAgICAgICBtZXNzYWdlLnNldmVyaXR5ID0gJ2luZm8nXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBtZXNzYWdlLnNldmVyaXR5ID0gJ2Vycm9yJ1xuICAgICAgfVxuICAgIH1cbiAgICBtZXNzYWdlLnZlcnNpb24gPSAxXG4gICAgbWVzc2FnZS5saW50ZXJOYW1lID0gbGludGVyTmFtZVxuICAgIG1lc3NhZ2Uua2V5ID0gbWVzc2FnZUtleUxlZ2FjeShtZXNzYWdlKVxuXG4gICAgaWYgKG1lc3NhZ2UudHJhY2UpIHtcbiAgICAgIG5vcm1hbGl6ZU1lc3NhZ2VzTGVnYWN5KGxpbnRlck5hbWUsIG1lc3NhZ2UudHJhY2UpXG4gICAgfVxuICB9XG59XG4iXX0=