'use babel';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _electron = require('electron');

var _crypto = require('crypto');

var _crypto2 = _interopRequireDefault(_crypto);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _fsPlus = require('fs-plus');

var _fsPlus2 = _interopRequireDefault(_fsPlus);

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : { default: obj };
}

let FileRecoveryService = class FileRecoveryService {
  constructor(recoveryDirectory) {
    this.recoveryDirectory = recoveryDirectory;
    this.recoveryFilesByFilePath = new Map();
    this.recoveryFilesByWindow = new WeakMap();
    this.windowsByRecoveryFile = new Map();
  }

  willSavePath(window, path) {
    if (!_fsPlus2.default.existsSync(path)) return;

    const recoveryPath = _path2.default.join(this.recoveryDirectory, RecoveryFile.fileNameForPath(path));
    const recoveryFile = this.recoveryFilesByFilePath.get(path) || new RecoveryFile(path, recoveryPath);

    try {
      recoveryFile.retain();
    } catch (err) {
      console.log(`Couldn't retain ${recoveryFile.recoveryPath}. Code: ${err.code}. Message: ${err.message}`);
      return;
    }

    if (!this.recoveryFilesByWindow.has(window)) {
      this.recoveryFilesByWindow.set(window, new Set());
    }
    if (!this.windowsByRecoveryFile.has(recoveryFile)) {
      this.windowsByRecoveryFile.set(recoveryFile, new Set());
    }

    this.recoveryFilesByWindow.get(window).add(recoveryFile);
    this.windowsByRecoveryFile.get(recoveryFile).add(window);
    this.recoveryFilesByFilePath.set(path, recoveryFile);
  }

  didSavePath(window, path) {
    const recoveryFile = this.recoveryFilesByFilePath.get(path);
    if (recoveryFile != null) {
      try {
        recoveryFile.release();
      } catch (err) {
        console.log(`Couldn't release ${recoveryFile.recoveryPath}. Code: ${err.code}. Message: ${err.message}`);
      }
      if (recoveryFile.isReleased()) this.recoveryFilesByFilePath.delete(path);
      this.recoveryFilesByWindow.get(window).delete(recoveryFile);
      this.windowsByRecoveryFile.get(recoveryFile).delete(window);
    }
  }

  didCrashWindow(window) {
    if (!this.recoveryFilesByWindow.has(window)) return;

    for (const recoveryFile of this.recoveryFilesByWindow.get(window)) {
      try {
        recoveryFile.recoverSync();
      } catch (error) {
        const message = 'A file that Atom was saving could be corrupted';
        const detail = `Error ${error.code}. There was a crash while saving "${recoveryFile.originalPath}", so this file might be blank or corrupted.\n` + `Atom couldn't recover it automatically, but a recovery file has been saved at: "${recoveryFile.recoveryPath}".`;
        console.log(detail);
        _electron.dialog.showMessageBox(window.browserWindow, { type: 'info', buttons: ['OK'], message, detail });
      } finally {
        for (let window of this.windowsByRecoveryFile.get(recoveryFile)) {
          this.recoveryFilesByWindow.get(window).delete(recoveryFile);
        }
        this.windowsByRecoveryFile.delete(recoveryFile);
        this.recoveryFilesByFilePath.delete(recoveryFile.originalPath);
      }
    }
  }

  didCloseWindow(window) {
    if (!this.recoveryFilesByWindow.has(window)) return;

    for (let recoveryFile of this.recoveryFilesByWindow.get(window)) {
      this.windowsByRecoveryFile.get(recoveryFile).delete(window);
    }
    this.recoveryFilesByWindow.delete(window);
  }
};
exports.default = FileRecoveryService;
let RecoveryFile = class RecoveryFile {
  static fileNameForPath(path) {
    const extension = _path2.default.extname(path);
    const basename = _path2.default.basename(path, extension).substring(0, 34);
    const randomSuffix = _crypto2.default.randomBytes(3).toString('hex');
    return `${basename}-${randomSuffix}${extension}`;
  }

  constructor(originalPath, recoveryPath) {
    this.originalPath = originalPath;
    this.recoveryPath = recoveryPath;
    this.refCount = 0;
  }

  storeSync() {
    _fsPlus2.default.copyFileSync(this.originalPath, this.recoveryPath);
  }

  recoverSync() {
    _fsPlus2.default.copyFileSync(this.recoveryPath, this.originalPath);
    this.removeSync();
  }

  removeSync() {
    _fsPlus2.default.unlinkSync(this.recoveryPath);
  }

  retain() {
    if (this.isReleased()) this.storeSync();
    this.refCount++;
  }

  release() {
    this.refCount--;
    if (this.isReleased()) this.removeSync();
  }

  isReleased() {
    return this.refCount === 0;
  }
};
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZpbGUtcmVjb3Zlcnktc2VydmljZS5qcyJdLCJuYW1lcyI6WyJGaWxlUmVjb3ZlcnlTZXJ2aWNlIiwiY29uc3RydWN0b3IiLCJyZWNvdmVyeURpcmVjdG9yeSIsInJlY292ZXJ5RmlsZXNCeUZpbGVQYXRoIiwiTWFwIiwicmVjb3ZlcnlGaWxlc0J5V2luZG93IiwiV2Vha01hcCIsIndpbmRvd3NCeVJlY292ZXJ5RmlsZSIsIndpbGxTYXZlUGF0aCIsIndpbmRvdyIsInBhdGgiLCJleGlzdHNTeW5jIiwicmVjb3ZlcnlQYXRoIiwiam9pbiIsIlJlY292ZXJ5RmlsZSIsImZpbGVOYW1lRm9yUGF0aCIsInJlY292ZXJ5RmlsZSIsImdldCIsInJldGFpbiIsImVyciIsImNvbnNvbGUiLCJsb2ciLCJjb2RlIiwibWVzc2FnZSIsImhhcyIsInNldCIsIlNldCIsImFkZCIsImRpZFNhdmVQYXRoIiwicmVsZWFzZSIsImlzUmVsZWFzZWQiLCJkZWxldGUiLCJkaWRDcmFzaFdpbmRvdyIsInJlY292ZXJTeW5jIiwiZXJyb3IiLCJkZXRhaWwiLCJvcmlnaW5hbFBhdGgiLCJzaG93TWVzc2FnZUJveCIsImJyb3dzZXJXaW5kb3ciLCJ0eXBlIiwiYnV0dG9ucyIsImRpZENsb3NlV2luZG93IiwiZXh0ZW5zaW9uIiwiZXh0bmFtZSIsImJhc2VuYW1lIiwic3Vic3RyaW5nIiwicmFuZG9tU3VmZml4IiwicmFuZG9tQnl0ZXMiLCJ0b1N0cmluZyIsInJlZkNvdW50Iiwic3RvcmVTeW5jIiwiY29weUZpbGVTeW5jIiwicmVtb3ZlU3luYyIsInVubGlua1N5bmMiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7O0FBRUE7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7Ozs7OztJLEFBRXFCLHNCQUFOLE1BQUEsQUFBTTtjQUNuQixBQUFhLG1CQUFtQixBQUM5QjtTQUFBLEFBQUssb0JBQUwsQUFBeUIsQUFDekI7U0FBQSxBQUFLLDBCQUEwQixJQUEvQixBQUErQixBQUFJLEFBQ25DO1NB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QSxBQUFhLGNBQWIsQUFBMkIsY0FBYyxBQUN2QztTQUFBLEFBQUssZUFBTCxBQUFvQixBQUNwQjtTQUFBLEFBQUssZUFBTCxBQUFvQixBQUNwQjtTQUFBLEFBQUssV0FBTCxBQUFnQixBQUNqQjtBQUVEOztjQUFhLEFBQ1g7cUJBQUEsQUFBRyxhQUFhLEtBQWhCLEFBQXFCLGNBQWMsS0FBbkMsQUFBd0MsQUFDekM7QUFFRDs7Z0JBQWUsQUFDYjtxQkFBQSxBQUFHLGFBQWEsS0FBaEIsQUFBcUIsY0FBYyxLQUFuQyxBQUF3QyxBQUN4QztTQUFBLEFBQUssQUFDTjtBQUVEOztlQUFjLEFBQ1o7cUJBQUEsQUFBRyxXQUFXLEtBQWQsQUFBbUIsQUFDcEI7QUFFRDs7V0FBVSxBQUNSO1FBQUksS0FBSixBQUFJLEFBQUssY0FBYyxLQUFBLEFBQUssQUFDNUI7U0FBQSxBQUFLLEFBQ047QUFFRDs7WUFBVyxBQUNUO1NBQUEsQUFBSyxBQUNMO1FBQUksS0FBSixBQUFJLEFBQUssY0FBYyxLQUFBLEFBQUssQUFDN0I7QUFFRDs7ZUFBYyxBQUNaO1dBQU8sS0FBQSxBQUFLLGFBQVosQUFBeUIsQUFDMUI7QUF2Q2dCLEE7QUFBQSxBQUNqQiIsImZpbGUiOiJmaWxlLXJlY292ZXJ5LXNlcnZpY2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIGJhYmVsJ1xuXG5pbXBvcnQge2RpYWxvZ30gZnJvbSAnZWxlY3Ryb24nXG5pbXBvcnQgY3J5cHRvIGZyb20gJ2NyeXB0bydcbmltcG9ydCBQYXRoIGZyb20gJ3BhdGgnXG5pbXBvcnQgZnMgZnJvbSAnZnMtcGx1cydcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRmlsZVJlY292ZXJ5U2VydmljZSB7XG4gIGNvbnN0cnVjdG9yIChyZWNvdmVyeURpcmVjdG9yeSkge1xuICAgIHRoaXMucmVjb3ZlcnlEaXJlY3RvcnkgPSByZWNvdmVyeURpcmVjdG9yeVxuICAgIHRoaXMucmVjb3ZlcnlGaWxlc0J5RmlsZVBhdGggPSBuZXcgTWFwKClcbiAgICB0aGlzLnJlY292ZXJ5RmlsZXNCeVdpbmRvdyA9IG5ldyBXZWFrTWFwKClcbiAgICB0aGlzLndpbmRvd3NCeVJlY292ZXJ5RmlsZSA9IG5ldyBNYXAoKVxuICB9XG5cbiAgd2lsbFNhdmVQYXRoICh3aW5kb3csIHBhdGgpIHtcbiAgICBpZiAoIWZzLmV4aXN0c1N5bmMocGF0aCkpIHJldHVyblxuXG4gICAgY29uc3QgcmVjb3ZlcnlQYXRoID0gUGF0aC5qb2luKHRoaXMucmVjb3ZlcnlEaXJlY3RvcnksIFJlY292ZXJ5RmlsZS5maWxlTmFtZUZvclBhdGgocGF0aCkpXG4gICAgY29uc3QgcmVjb3ZlcnlGaWxlID1cbiAgICAgIHRoaXMucmVjb3ZlcnlGaWxlc0J5RmlsZVBhdGguZ2V0KHBhdGgpIHx8IG5ldyBSZWNvdmVyeUZpbGUocGF0aCwgcmVjb3ZlcnlQYXRoKVxuXG4gICAgdHJ5IHtcbiAgICAgIHJlY292ZXJ5RmlsZS5yZXRhaW4oKVxuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgY29uc29sZS5sb2coYENvdWxkbid0IHJldGFpbiAke3JlY292ZXJ5RmlsZS5yZWNvdmVyeVBhdGh9LiBDb2RlOiAke2Vyci5jb2RlfS4gTWVzc2FnZTogJHtlcnIubWVzc2FnZX1gKVxuICAgICAgcmV0dXJuXG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLnJlY292ZXJ5RmlsZXNCeVdpbmRvdy5oYXMod2luZG93KSkge1xuICAgICAgdGhpcy5yZWNvdmVyeUZpbGVzQnlXaW5kb3cuc2V0KHdpbmRvdywgbmV3IFNldCgpKVxuICAgIH1cbiAgICBpZiAoIXRoaXMud2luZG93c0J5UmVjb3ZlcnlGaWxlLmhhcyhyZWNvdmVyeUZpbGUpKSB7XG4gICAgICB0aGlzLndpbmRvd3NCeVJlY292ZXJ5RmlsZS5zZXQocmVjb3ZlcnlGaWxlLCBuZXcgU2V0KCkpXG4gICAgfVxuXG4gICAgdGhpcy5yZWNvdmVyeUZpbGVzQnlXaW5kb3cuZ2V0KHdpbmRvdykuYWRkKHJlY292ZXJ5RmlsZSlcbiAgICB0aGlzLndpbmRvd3NCeVJlY292ZXJ5RmlsZS5nZXQocmVjb3ZlcnlGaWxlKS5hZGQod2luZG93KVxuICAgIHRoaXMucmVjb3ZlcnlGaWxlc0J5RmlsZVBhdGguc2V0KHBhdGgsIHJlY292ZXJ5RmlsZSlcbiAgfVxuXG4gIGRpZFNhdmVQYXRoICh3aW5kb3csIHBhdGgpIHtcbiAgICBjb25zdCByZWNvdmVyeUZpbGUgPSB0aGlzLnJlY292ZXJ5RmlsZXNCeUZpbGVQYXRoLmdldChwYXRoKVxuICAgIGlmIChyZWNvdmVyeUZpbGUgIT0gbnVsbCkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgcmVjb3ZlcnlGaWxlLnJlbGVhc2UoKVxuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGBDb3VsZG4ndCByZWxlYXNlICR7cmVjb3ZlcnlGaWxlLnJlY292ZXJ5UGF0aH0uIENvZGU6ICR7ZXJyLmNvZGV9LiBNZXNzYWdlOiAke2Vyci5tZXNzYWdlfWApXG4gICAgICB9XG4gICAgICBpZiAocmVjb3ZlcnlGaWxlLmlzUmVsZWFzZWQoKSkgdGhpcy5yZWNvdmVyeUZpbGVzQnlGaWxlUGF0aC5kZWxldGUocGF0aClcbiAgICAgIHRoaXMucmVjb3ZlcnlGaWxlc0J5V2luZG93LmdldCh3aW5kb3cpLmRlbGV0ZShyZWNvdmVyeUZpbGUpXG4gICAgICB0aGlzLndpbmRvd3NCeVJlY292ZXJ5RmlsZS5nZXQocmVjb3ZlcnlGaWxlKS5kZWxldGUod2luZG93KVxuICAgIH1cbiAgfVxuXG4gIGRpZENyYXNoV2luZG93ICh3aW5kb3cpIHtcbiAgICBpZiAoIXRoaXMucmVjb3ZlcnlGaWxlc0J5V2luZG93Lmhhcyh3aW5kb3cpKSByZXR1cm5cblxuICAgIGZvciAoY29uc3QgcmVjb3ZlcnlGaWxlIG9mIHRoaXMucmVjb3ZlcnlGaWxlc0J5V2luZG93LmdldCh3aW5kb3cpKSB7XG4gICAgICB0cnkge1xuICAgICAgICByZWNvdmVyeUZpbGUucmVjb3ZlclN5bmMoKVxuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc3QgbWVzc2FnZSA9ICdBIGZpbGUgdGhhdCBBdG9tIHdhcyBzYXZpbmcgY291bGQgYmUgY29ycnVwdGVkJ1xuICAgICAgICBjb25zdCBkZXRhaWwgPVxuICAgICAgICAgIGBFcnJvciAke2Vycm9yLmNvZGV9LiBUaGVyZSB3YXMgYSBjcmFzaCB3aGlsZSBzYXZpbmcgXCIke3JlY292ZXJ5RmlsZS5vcmlnaW5hbFBhdGh9XCIsIHNvIHRoaXMgZmlsZSBtaWdodCBiZSBibGFuayBvciBjb3JydXB0ZWQuXFxuYCArXG4gICAgICAgICAgYEF0b20gY291bGRuJ3QgcmVjb3ZlciBpdCBhdXRvbWF0aWNhbGx5LCBidXQgYSByZWNvdmVyeSBmaWxlIGhhcyBiZWVuIHNhdmVkIGF0OiBcIiR7cmVjb3ZlcnlGaWxlLnJlY292ZXJ5UGF0aH1cIi5gXG4gICAgICAgIGNvbnNvbGUubG9nKGRldGFpbClcbiAgICAgICAgZGlhbG9nLnNob3dNZXNzYWdlQm94KHdpbmRvdy5icm93c2VyV2luZG93LCB7dHlwZTogJ2luZm8nLCBidXR0b25zOiBbJ09LJ10sIG1lc3NhZ2UsIGRldGFpbH0pXG4gICAgICB9IGZpbmFsbHkge1xuICAgICAgICBmb3IgKGxldCB3aW5kb3cgb2YgdGhpcy53aW5kb3dzQnlSZWNvdmVyeUZpbGUuZ2V0KHJlY292ZXJ5RmlsZSkpIHtcbiAgICAgICAgICB0aGlzLnJlY292ZXJ5RmlsZXNCeVdpbmRvdy5nZXQod2luZG93KS5kZWxldGUocmVjb3ZlcnlGaWxlKVxuICAgICAgICB9XG4gICAgICAgIHRoaXMud2luZG93c0J5UmVjb3ZlcnlGaWxlLmRlbGV0ZShyZWNvdmVyeUZpbGUpXG4gICAgICAgIHRoaXMucmVjb3ZlcnlGaWxlc0J5RmlsZVBhdGguZGVsZXRlKHJlY292ZXJ5RmlsZS5vcmlnaW5hbFBhdGgpXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZGlkQ2xvc2VXaW5kb3cgKHdpbmRvdykge1xuICAgIGlmICghdGhpcy5yZWNvdmVyeUZpbGVzQnlXaW5kb3cuaGFzKHdpbmRvdykpIHJldHVyblxuXG4gICAgZm9yIChsZXQgcmVjb3ZlcnlGaWxlIG9mIHRoaXMucmVjb3ZlcnlGaWxlc0J5V2luZG93LmdldCh3aW5kb3cpKSB7XG4gICAgICB0aGlzLndpbmRvd3NCeVJlY292ZXJ5RmlsZS5nZXQocmVjb3ZlcnlGaWxlKS5kZWxldGUod2luZG93KVxuICAgIH1cbiAgICB0aGlzLnJlY292ZXJ5RmlsZXNCeVdpbmRvdy5kZWxldGUod2luZG93KVxuICB9XG59XG5cbmNsYXNzIFJlY292ZXJ5RmlsZSB7XG4gIHN0YXRpYyBmaWxlTmFtZUZvclBhdGggKHBhdGgpIHtcbiAgICBjb25zdCBleHRlbnNpb24gPSBQYXRoLmV4dG5hbWUocGF0aClcbiAgICBjb25zdCBiYXNlbmFtZSA9IFBhdGguYmFzZW5hbWUocGF0aCwgZXh0ZW5zaW9uKS5zdWJzdHJpbmcoMCwgMzQpXG4gICAgY29uc3QgcmFuZG9tU3VmZml4ID0gY3J5cHRvLnJhbmRvbUJ5dGVzKDMpLnRvU3RyaW5nKCdoZXgnKVxuICAgIHJldHVybiBgJHtiYXNlbmFtZX0tJHtyYW5kb21TdWZmaXh9JHtleHRlbnNpb259YFxuICB9XG5cbiAgY29uc3RydWN0b3IgKG9yaWdpbmFsUGF0aCwgcmVjb3ZlcnlQYXRoKSB7XG4gICAgdGhpcy5vcmlnaW5hbFBhdGggPSBvcmlnaW5hbFBhdGhcbiAgICB0aGlzLnJlY292ZXJ5UGF0aCA9IHJlY292ZXJ5UGF0aFxuICAgIHRoaXMucmVmQ291bnQgPSAwXG4gIH1cblxuICBzdG9yZVN5bmMgKCkge1xuICAgIGZzLmNvcHlGaWxlU3luYyh0aGlzLm9yaWdpbmFsUGF0aCwgdGhpcy5yZWNvdmVyeVBhdGgpXG4gIH1cblxuICByZWNvdmVyU3luYyAoKSB7XG4gICAgZnMuY29weUZpbGVTeW5jKHRoaXMucmVjb3ZlcnlQYXRoLCB0aGlzLm9yaWdpbmFsUGF0aClcbiAgICB0aGlzLnJlbW92ZVN5bmMoKVxuICB9XG5cbiAgcmVtb3ZlU3luYyAoKSB7XG4gICAgZnMudW5saW5rU3luYyh0aGlzLnJlY292ZXJ5UGF0aClcbiAgfVxuXG4gIHJldGFpbiAoKSB7XG4gICAgaWYgKHRoaXMuaXNSZWxlYXNlZCgpKSB0aGlzLnN0b3JlU3luYygpXG4gICAgdGhpcy5yZWZDb3VudCsrXG4gIH1cblxuICByZWxlYXNlICgpIHtcbiAgICB0aGlzLnJlZkNvdW50LS1cbiAgICBpZiAodGhpcy5pc1JlbGVhc2VkKCkpIHRoaXMucmVtb3ZlU3luYygpXG4gIH1cblxuICBpc1JlbGVhc2VkICgpIHtcbiAgICByZXR1cm4gdGhpcy5yZWZDb3VudCA9PT0gMFxuICB9XG59XG4iXX0=